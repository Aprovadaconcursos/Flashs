<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Editor + Firebase (Corrigido)</title>

  <style>
    /* ==================== SEU CSS COMPLETO ==================== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f6f9;
      color: #333;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .page-title {
      background-color: #fff;
      padding: 15px;
      margin-bottom: 10px;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 22px;
      font-weight: bold;
      border-radius: 8px;
    }
    #editorTitle {
      display: none;
    }

    .input-area {
      background-color: #ffffff;
      padding: 20px;
      border-bottom: 1px solid #ddd;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .editable-div {
      width: 100%;
      height: 120px;
      padding: 10px 15px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
      line-height: 1.5;
      resize: vertical;
      overflow-y: auto;
      transition: border-color 0.3s;
    }
    .editable-div:focus {
      outline: none;
      border-color: #007BFF;
      box-shadow: 0 0 5px rgba(0,123,255,0.5);
    }

    .container {
      flex: 1;
      padding: 20px 0;
      display: flex;
      flex-direction: column;
      gap: 0;
      overflow-y: auto;
    }

    .box {
      background-color: #f0f0f0; 
      border: 1px solid #ddd;
      border-radius: 8px;
      height: 45px;
      display: flex;
      align-items: center;
      padding: 0 15px;
      font-size: 16px;
      transition: background-color 0.3s, height 0.3s, border-color 0.3s;
      cursor: text;
      position: relative;
      width: 100%;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    .box.colored {
      height: 50px;
      background-color: #e6f2ff;
    }
    .box:focus-within {
      border-color: #007BFF;
      box-shadow: 0 0 5px rgba(0,123,255,0.3);
      background-color: #e6f2ff;
    }
    .box:hover {
      border-color: #007BFF;
    }

    .custom-context-menu {
      position: absolute;
      background-color: #ffffff;
      border: 1px solid #ddd;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      padding: 10px 0;
      z-index: 1000;
      width: 220px;
      display: none;
      border-radius: 6px;
    }
    .custom-context-menu ul {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    .custom-context-menu li {
      padding: 10px 20px;
      cursor: pointer;
      position: relative;
      transition: background-color 0.2s;
    }
    .custom-context-menu li:hover {
      background-color: #f1f1f1;
    }
    .submenu {
      position: relative;
    }
    .submenu > ul {
      position: absolute;
      top: 0;
      left: 100%;
      background-color: #ffffff;
      border: 1px solid #ddd;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      padding: 10px 0;
      display: none;
      border-radius: 6px;
      min-width: 150px;
      z-index: 1001;
    }
    .submenu:hover > ul {
      display: block;
    }
    .submenu::after {
      content: '▶';
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 12px;
      color: #555;
    }

    @media (max-width: 600px) {
      .editable-div, .box {
        font-size: 14px;
      }
      .custom-context-menu {
        width: 180px;
      }
      .submenu > ul {
        min-width: 120px;
      }
    }

    #folderScreen {
      padding: 20px;
      position: relative;
      width: 100%;
      height: 100%;
      display: none;
    }
    #folderList {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      margin-top: 20px;
      width: 100%;
    }
    .folder-item {
      width: 100px;
      height: 120px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      background-color: #e0e0e0; 
      border: 1px solid #ddd;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s;
      font-size: 16px;
      position: relative;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .folder-item:hover {
      background-color: #f5f5f5;
    }
    .folder-icon {
      font-size: 40px;
      margin-top: 10px;
    }
    .folder-name {
      margin-top: 5px;
      padding: 0 5px;
      font-size: 14px;
      line-height: 1.2;
      word-wrap: break-word;
      font-weight: bold;
    }

    #subFolderScreen {
      display: none;
      padding: 20px;
      position: relative;
      width: 100%;
      height: 100%;
    }
    #subFolderList {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .subfolder-item {
      background-color: #e0e0e0; 
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px 15px;
      cursor: pointer;
      transition: background-color 0.3s;
      font-size: 16px;
      font-weight: bold;
      position: relative;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .subfolder-item:hover {
      background-color: #f5f5f5;
    }

    #documentListScreen {
      display: none;
      padding: 20px;
      position: relative;
      width: 100%;
      height: 100%;
    }
    #documentList {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .doc-item {
      background-color: #ffffff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px 15px;
      cursor: pointer;
      transition: background-color 0.3s;
      font-size: 16px;
      position: relative;
    }
    .doc-item:hover {
      background-color: #e0e0e0;
    }
    .doc-item-title {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .doc-item-subject {
      font-size: 14px;
      color: #666;
      white-space: pre-wrap;
      margin-left: 20px;
      position: relative;
    }
    .doc-item-subject::before {
      content: "- ";
      position: absolute;
      left: -15px;
    }

    .folder-header,
    .document-header {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      position: relative;
    }
    .plus-button {
      border: none;
      background: #fff;
      color: #aaa; 
      font-size: 28px;
      border-radius: 6px;
      padding: 5px 10px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .plus-button:hover {
      background-color: #eee;
    }
    .nav-buttons {
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .nav-button {
      font-size: 28px;
      border: none;
      background: #fff;
      border-radius: 6px;
      padding: 5px 10px;
      cursor: pointer;
      color: #aaa;
      transition: background-color 0.2s;
    }
    .nav-button:hover {
      background-color: #eee;
      color: #777; 
    }
    #createDocumentForm {
      display: none;
      margin-top: 20px;
      text-align: center;
    }
    #createDocumentForm label {
      display: block;
      margin-bottom: 6px;
      font-weight: bold;
    }
    #createDocumentForm input {
      width: 80%;
      max-width: 400px;
      padding: 8px;
      margin-bottom: 10px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    #editorSection .nav-buttons {
      justify-content: center;
    }
    .context-menu-folder,
    .context-menu-doc,
    .context-menu-subfolder,
    .context-menu-background {
      position: absolute;
      background-color: #fff;
      border: 1px solid #ddd;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 9999;
      display: none;
      border-radius: 6px;
    }
    .context-menu-folder ul,
    .context-menu-doc ul,
    .context-menu-subfolder ul,
    .context-menu-background ul {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    .context-menu-folder li,
    .context-menu-doc li,
    .context-menu-subfolder li,
    .context-menu-background li {
      padding: 10px 20px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .context-menu-folder li:hover,
    .context-menu-doc li:hover,
    .context-menu-subfolder li:hover,
    .context-menu-background li:hover {
      background-color: #f1f1f1;
    }

    #loginScreen, #registerScreen {
      display: none;
      text-align: center;
      padding: 20px;
    }
  </style>
</head>

<body>

  <!-- ===================== TELA DE LOGIN ===================== -->
  <div id="loginScreen">
    <h2>Fazer Login</h2>
    <input type="email" id="emailInput" placeholder="Seu e-mail"><br><br>
    <input type="password" id="passwordInput" placeholder="Sua senha"><br><br>
    <button id="loginBtn">Entrar</button>
    <p>Não tem conta? <a href="#" id="goRegisterLink">Cadastrar</a></p>
  </div>

  <!-- ===================== TELA DE CADASTRO ===================== -->
  <div id="registerScreen">
    <h2>Cadastrar</h2>
    <input type="email" id="regEmailInput" placeholder="Seu e-mail"><br><br>
    <input type="password" id="regPasswordInput" placeholder="Sua senha"><br><br>
    <button id="registerBtn">Cadastrar</button>
    <p>Já tem conta? <a href="#" id="goLoginLink">Fazer login</a></p>
  </div>

  <!-- ===================== TELA DE PASTAS ===================== -->
  <div id="folderScreen">
    <div class="page-title" id="folderScreenTitle">Painel inicial</div>
    <div class="folder-header">
      <button id="createFolderBtn" class="plus-button">+</button>
      <div class="nav-buttons">
        <button class="nav-button" id="folderLeftArrow"  title="Voltar (início)">&larr;</button>
        <button class="nav-button" id="folderRightArrow" title="Avançar (não há avançar)">&rarr;</button>
      </div>
    </div>
    <button id="logoutBtn" style="position:absolute; top:20px; right:20px;">Sair</button>
    <div id="folderList"></div>
  </div>

  <!-- ===================== TELA DE SUBPASTAS ===================== -->
  <div id="subFolderScreen" style="display:none;">
    <div class="page-title" id="subFolderTitle"></div>
    <div class="folder-header">
      <button id="btnCreateSubFolder" class="plus-button">+</button>
      <div class="nav-buttons">
        <button class="nav-button" id="subFolderLeftArrow"  title="Voltar para Pastas">&larr;</button>
        <button class="nav-button" id="subFolderRightArrow" title="Não há tela seguinte">&rarr;</button>
      </div>
    </div>
    <div id="subFolderList"></div>
  </div>

  <!-- ===================== TELA DE DOCUMENTOS ===================== -->
  <div id="documentListScreen" style="display:none;">
    <div class="page-title">
      <div id="documentListTitle"></div>
    </div>
    <div class="document-header">
      <button id="btnCreateDoc" class="plus-button">+</button>
      <div class="nav-buttons">
        <button class="nav-button" id="docLeftArrow"  title="Voltar">&larr;</button>
        <button class="nav-button" id="docRightArrow" title="Não há avanço">&rarr;</button>
      </div>
    </div>
    <div id="createDocumentForm" style="margin-top:20px;text-align:center;display:none;">
      <label for="docNameInput">Nome do Documento:</label>
      <input type="text" id="docNameInput"    placeholder="Ex: Relatório 2025" />
      <label for="docSubjectInput">Assunto:</label>
      <input type="text" id="docSubjectInput" placeholder="Ex: Análise de Custos..." />
      <button onclick="createNewDocument()">Salvar</button>
    </div>
    <div id="documentList"></div>
  </div>

  <!-- ===================== TELA DO EDITOR ===================== -->
  <div id="editorSection" style="display:none;">
    <div class="page-title" id="editorTitle">Editor</div>
    <div class="input-area" id="inputArea">
      <div class="editable-div" id="textInput" contenteditable="true" placeholder="Cole seu texto aqui..."></div>
      <button onclick="processText()">Gerar Texto</button>
      <button id="loadButton" onclick="loadLastDocument()" style="margin-left:10px;">&#x21BA; Último Documento</button>
    </div>
    <div class="nav-buttons" style="margin-top:10px;">
      <button class="nav-button" id="editorLeftArrow"  title="Voltar para documentos">&larr;</button>
      <button class="nav-button" id="editorRightArrow" title="Nenhum avanço">&rarr;</button>
    </div>
    <div class="container" id="textContainer"></div>
    <div class="custom-context-menu" id="contextMenu">
      <ul>
        <li id="deleteBlock">Excluir Bloco</li>
        <li id="centerImageInsideBlock">Centralizar Imagem no Bloco</li>
        <li class="submenu">Alterar Tamanho da Fonte
          <ul>
            <li data-font-size="14px">14px</li>
            <li data-font-size="16px">16px</li>
            <li data-font-size="18px">18px</li>
            <li data-font-size="20px">20px</li>
            <li data-font-size="22px">22px</li>
          </ul>
        </li>
        <li class="submenu">Alterar Cor da Linha
          <ul>
            <li data-color="#f0f0f0">Cinza Claro</li>
            <li data-color="#00B050">Verde</li>
            <li data-color="#FFC000">Amarelo</li>
            <li data-color="#00B0F0">Azul</li>
            <li data-color="#00C0C0">Turquesa</li>
            <li data-color="#F79646">Laranja</li>
            <li data-color="#FF00FF">Magenta</li>
            <li data-color="#00FF00">Verde Vibrante</li>
            <li data-color="#FFFF00">Amarelo Vibrante</li>
            <li data-color="#FF69B4">Rosa Shock</li>
          </ul>
        </li>
      </ul>
    </div>
  </div>

  <!-- ===================== MENUS DE CONTEXTO (Vazios) ===================== -->
  <div class="context-menu-folder"    id="contextMenuFolder"><ul></ul></div>
  <div class="context-menu-subfolder" id="contextMenuSubFolder"><ul></ul></div>
  <div class="context-menu-doc"       id="contextMenuDoc"><ul></ul></div>
  <div class="context-menu-background"id="contextMenuBackground"><ul></ul></div>


  <!-- ===================== SCRIPT "ES MODULES" ===================== -->
  <script type="module">
    /* 
       Import das bibliotecas via CDN Firebase (versão 9.17.2)
    */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
    import { getAuth,
             createUserWithEmailAndPassword,
             signInWithEmailAndPassword,
             onAuthStateChanged,
             signOut } 
      from "https://www.gstatic.com/firebasejs/9.17.2/firebase-auth.js";
    import { getFirestore,
             doc,
             getDoc,
             setDoc }
      from "https://www.gstatic.com/firebasejs/9.17.2/firebase-firestore.js";

    /* 
       AQUI ESTÃO SUAS CHAVES do projeto "sistema-b8c6c".
    */
    const firebaseConfig = {
      apiKey: "AIzaSyDNLcuknXeyddvqAVtul6RCOMVrlfwJQPo",
      authDomain: "sistema-b8c6c.firebaseapp.com",
      projectId: "sistema-b8c6c",
      storageBucket: "sistema-b8c6c.firebasestorage.app",
      messagingSenderId: "661126236594",
      appId: "1:661126236594:web:f18abb296d9ba7cc6ebcab"
    };

    // Inicializa
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    /* ====================== VARIÁVEIS GLOBAIS ====================== */
    let folders          = [];
    let folderSubfolders = {};
    let namedDocuments   = [];
    let currentUserUid   = null;

    let currentFolder     = null;
    let currentSubFolder  = null;
    let currentDocName    = null;
    let currentDocSubject = null;
    let copyBuffer        = null;

    // Elementos de tela (Login, etc.)
    const loginScreen    = document.getElementById("loginScreen");
    const registerScreen = document.getElementById("registerScreen");
    const folderScreen   = document.getElementById("folderScreen");
    const loginBtn       = document.getElementById("loginBtn");
    const registerBtn    = document.getElementById("registerBtn");
    const goRegisterLink = document.getElementById("goRegisterLink");
    const goLoginLink    = document.getElementById("goLoginLink");
    const logoutBtn      = document.getElementById("logoutBtn");

    goRegisterLink.addEventListener("click",(e)=>{
      e.preventDefault();
      loginScreen.style.display    = "none";
      registerScreen.style.display = "block";
    });
    goLoginLink.addEventListener("click",(e)=>{
      e.preventDefault();
      registerScreen.style.display = "none";
      loginScreen.style.display    = "block";
    });

    loginBtn.addEventListener("click", async ()=>{
      const email = document.getElementById("emailInput").value;
      const pass  = document.getElementById("passwordInput").value;
      try {
        await signInWithEmailAndPassword(auth, email, pass);
        console.log("Login ok!");
      } catch(err){
        alert("Erro ao logar: " + err.message);
      }
    });

    registerBtn.addEventListener("click", async ()=>{
      const email = document.getElementById("regEmailInput").value;
      const pass  = document.getElementById("regPasswordInput").value;
      try {
        await createUserWithEmailAndPassword(auth, email, pass);
        console.log("Cadastro ok!");
      } catch(err){
        alert("Erro ao cadastrar: " + err.message);
      }
    });

    logoutBtn.addEventListener("click", async ()=>{
      await signOut(auth);
      console.log("Deslogado!");
    });

    // Verifica se user logou ou deslogou
    onAuthStateChanged(auth, async (user)=>{
      if(user){
        currentUserUid = user.uid;
        console.log("Logado:", user.uid);
        loginScreen.style.display    = "none";
        registerScreen.style.display = "none";
        await loadAllData(user.uid);
        folderScreen.style.display   = "block";
      } else {
        console.log("Ninguém logado");
        currentUserUid = null;
        folderScreen.style.display             = "none";
        document.getElementById("subFolderScreen").style.display  = "none";
        document.getElementById("documentListScreen").style.display= "none";
        document.getElementById("editorSection").style.display     = "none";
        loginScreen.style.display    = "block";
        registerScreen.style.display = "none";
      }
    });

    // ================= LEITURA / ESCRITA NO FIRESTORE =================
    async function loadAllData(uid){
      const ref = doc(db, "userData", uid);
      const snap= await getDoc(ref);
      if(snap.exists()){
        const data=snap.data();
        folders          = data.folders          || [];
        folderSubfolders = data.folderSubfolders || {};
        namedDocuments   = data.namedDocuments   || [];
      } else {
        folders          = [];
        folderSubfolders = {};
        namedDocuments   = [];
      }
      console.log("Dados carregados. Pastas:", folders.length);
      showFolderScreen();
    }

    async function saveAllData(){
      if(!currentUserUid) return;
      const ref = doc(db, "userData", currentUserUid);
      await setDoc(ref, {
        folders,
        folderSubfolders,
        namedDocuments
      });
      console.log("Dados salvos no Firestore.");
    }

    /* ==================== RESTO DO EDITOR (createFolder, showFolderScreen, etc.) ==================== */
    /* Exemplo: Botões Pasta */
    const folderLeftArrow  = document.getElementById("folderLeftArrow");
    const folderRightArrow = document.getElementById("folderRightArrow");
    const createFolderBtn  = document.getElementById("createFolderBtn");

    folderLeftArrow.addEventListener("click", ()=> showFolderScreen());
    folderRightArrow.addEventListener("click", ()=> alert("Não há tela seguinte."));
    createFolderBtn.addEventListener("click", ()=> createFolder());

    // Subpastas
    const subFolderLeftArrow  = document.getElementById("subFolderLeftArrow");
    const subFolderRightArrow = document.getElementById("subFolderRightArrow");
    const btnCreateSubFolder  = document.getElementById("btnCreateSubFolder");
    subFolderLeftArrow.addEventListener("click", ()=> showFolderScreen());
    subFolderRightArrow.addEventListener("click", ()=> alert("Não há tela seguinte."));
    btnCreateSubFolder.addEventListener("click", ()=> {
      if(!currentFolder) return;
      createSubFolder(currentFolder);
    });

    // Documentos
    const docLeftArrow = document.getElementById("docLeftArrow");
    const docRightArrow= document.getElementById("docRightArrow");
    const btnCreateDoc = document.getElementById("btnCreateDoc");
    docLeftArrow.addEventListener("click", ()=> showSubFolderScreen(currentFolder));
    docRightArrow.addEventListener("click", ()=> alert("Não há tela seguinte."));
    btnCreateDoc.addEventListener("click", ()=> showCreateDocForm());

    // Editor
    const editorLeftArrow = document.getElementById("editorLeftArrow");
    const editorRightArrow= document.getElementById("editorRightArrow");
    editorLeftArrow.addEventListener("click", ()=> {
      showDocumentList(currentFolder, currentSubFolder);
    });
    editorRightArrow.addEventListener("click", ()=> alert("Não há tela seguinte."));

    // Exemplo da função createFolder():
    function createFolder(){
      const folderName = prompt("Digite o nome da nova pasta:");
      if(!folderName) return;
      if(folders.includes(folderName)){
        alert("Já existe uma pasta com este nome.");
        return;
      }
      folders.push(folderName);
      if(!folderSubfolders[folderName]){
        folderSubfolders[folderName] = [];
      }
      saveAllData();
      showFolderScreen();
    }

    function showFolderScreen(){
      document.getElementById("folderScreen").style.display     = "block";
      document.getElementById("subFolderScreen").style.display  = "none";
      document.getElementById("documentListScreen").style.display = "none";
      document.getElementById("editorSection").style.display    = "none";

      currentFolder     = null;
      currentSubFolder  = null;
      currentDocName    = null;
      currentDocSubject = null;

      const folderList = document.getElementById("folderList");
      folderList.innerHTML = "";

      if (folders.length === 0) {
        const msg = document.createElement("div");
        msg.textContent = "Nenhuma pasta criada ainda.";
        folderList.appendChild(msg);
      } else {
        folders.forEach(folderName => {
          const folderItem = document.createElement("div");
          folderItem.classList.add("folder-item");
          // Ícone
          const icon = document.createElement("div");
          icon.classList.add("folder-icon");
          icon.textContent = "📂";
          folderItem.appendChild(icon);

          // Nome
          const nameDiv = document.createElement("div");
          nameDiv.classList.add("folder-name");
          nameDiv.textContent = folderName;
          folderItem.appendChild(nameDiv);

          folderItem.onclick = ()=> enterFolder(folderName);
          folderList.appendChild(folderItem);
        });
      }
    }

    function enterFolder(folderName){
      currentFolder = folderName;
      showSubFolderScreen(folderName);
    }

    /* ... e assim sucessivamente para subpastas, documentos, editor, etc... */
    
    // (Cole o resto do seu código do Editor, 
    //  substituindo localStorage por "saveAllData()" e "loadAllData(...)" 
    //  caso não tenha feito ainda.)

  </script>
</body>
</html>
