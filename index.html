<!DOCTYPE html> 
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema com Editor Estilo Excel + Firebase</title>
  <!-- Biblioteca Mammoth.js para conversão de DOCX para HTML -->
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
  <style>
    /* (Todo o seu CSS exatamente igual, sem mudanças) */
    /* ------------------------------------------------ */
    html, body {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      padding: 20px;
      background-color: #f4f4f4;
      font-family: 'Lato', sans-serif;
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      height: 100vh;
      position: relative;
    }
    * { box-sizing: inherit; }
    a { cursor: pointer; }
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Lato:wght@300&display=swap');
    .completion-square {
      position: absolute; right: 5px; top: 50%; transform: translateY(-50%);
      width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
      font-size: 12px; color: #555; background-color: transparent; border: 1px solid #ccc; border-radius: 50%;
      cursor: pointer;
    }
    .completion-square.completed { background-color: #d0f0c0; }
    #loginScreen { display: flex; flex-direction: column; width: 100%; height: 100%; position: relative; }
    .header { display: flex; align-items: center; }
    .logo-container { display: flex; align-items: center; }
    .logo-icon {
      width: 50px; height: 50px; background-color: #007BFF; border-radius: 50%; display: flex; justify-content: center; align-items: center;
      margin-right: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .logo-icon::after { content: '\1F310'; font-size: 24px; color: white; }
    .logo {
      font-family: 'Montserrat', sans-serif; font-weight: 900; font-size: 48px; letter-spacing: 3px; color: #007BFF;
      text-shadow: 2px 2px 10px rgba(0,0,0,0.1);
    }
    .slogan {
      font-family: 'Lato', sans-serif; font-weight: 300; font-size: 18px; color: #666; margin-top: 20px; padding-left: 80px;
    }
    .container {
      background: #fff; padding: 30px; margin: 20px auto; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      width: 90%; max-width: 400px;
    }
    .access-text {
      font-family: 'Montserrat', sans-serif; font-weight: 700; font-size: 20px; color: #333; text-align: center; margin-bottom: 20px;
    }
    .login-form { display: flex; flex-direction: column; }
    .login-form input {
      font-family: 'Lato', sans-serif; font-size: 16px; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px;
    }
    .login-form button {
      font-family: 'Lato', sans-serif; font-size: 16px; background-color: #007BFF; color: white; border: none;
      padding: 12px; border-radius: 5px; cursor: pointer;
    }
    .login-form button:hover { background-color: #0056b3; }
    .register { font-size: 14px; margin-top: 15px; text-align: center; }
    .register a { color: #007BFF; text-decoration: none; }
    .info-box {
      position: fixed; top: 180px; right: 50px; font-size: 18px; font-weight: 400; color: #333;
    }
    @media (max-width: 1024px) { .info-box { right: 20px; font-size: 16px; } }
    @media (max-width: 768px) { .info-box { right: 10px; font-size: 14px; } }
    @media (max-width: 600px) {
      .info-box {
        position: relative; top: auto; right: auto; margin: 20px auto; text-align: center;
      }
    }
    .info-box div { margin-bottom: 15px; }
    .highlight-text {
      font-family: 'Montserrat', sans-serif; font-size: 20px; font-weight: 700; color: #007BFF; margin-top: 30px;
    }
    #registerScreen {
      display: none; text-align: center; padding: 20px; width: 100%; box-sizing: border-box;
    }
    #folderScreen {
      display: none; padding: 20px; position: relative; width: 100%; box-sizing: border-box;
    }
    .page-title {
      background-color: #fff; padding: 15px; margin-bottom: 10px; border-bottom: 1px solid #ddd; display: flex;
      justify-content: center; align-items: center; font-size: 22px; font-weight: bold; border-radius: 8px;
    }
    .folder-header {
      display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; position: relative;
    }
    #folderScreen .folder-header .nav-buttons {
      position: absolute; left: 50%; transform: translateX(-50%);
    }
    .nav-buttons {
      display: flex; justify-content: center; align-items: center; gap: 20px; width: 100%; margin: 10px 0; flex-wrap: wrap;
    }
    .plus-button {
      border: none; background: #fff; color: #aaa; font-size: 28px; border-radius: 6px; padding: 5px 10px;
      cursor: pointer; transition: background-color 0.2s;
    }
    .plus-button:hover { background-color: #eee; }
    .folder-header .plus-button { position: relative; z-index: 10; }
    .nav-button {
      font-size: 28px; border: none; background: #fff; border-radius: 6px; padding: 5px 10px; cursor: pointer;
      color: #aaa; transition: background-color 0.2s; min-width: 60px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .nav-button:hover { background-color: #eee; color: #777; }
    #folderList {
      display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; margin-top: 20px; width: 100%;
    }
    .folder-item {
      flex: 1 1 120px; max-width: 150px; height: auto; display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
      background-color: #e0e0e0; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; transition: background-color 0.3s;
      font-size: 16px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: relative;
    }
    .folder-item:hover { background-color: #f5f5f5; }
    .folder-icon { font-size: 48px; margin-top: 10px; }
    .folder-name {
      margin-top: 5px; padding: 0 5px; font-size: 14px; font-weight: bold;
    }
    #subFolderScreen {
      display: none; padding: 20px; position: relative; width: 100%; box-sizing: border-box;
    }
    #subFolderList {
      margin-top: 10px; display: flex; flex-direction: column; gap: 5px;
    }
    .subfolder-item {
      background-color: #e0e0e0; border: 1px solid #ddd; border-radius: 8px; padding: 10px 15px; cursor: pointer;
      transition: background-color 0.3s; font-size: 16px; font-weight: bold; position: relative; display: flex; align-items: center;
    }
    .subfolder-item span { margin-left: 0; }
    .subfolder-favorited { background-color: #b0bec5 !important; }
    #subFolderTotalCount {
      text-align: right; font-size: 14px; color: #555; margin-top: 10px;
    }
    #subFolderCompletionPercent {
      position: absolute; top: 90px; right: 20px; width: 100px; height: 100px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; color: white;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.6); cursor: default;
    }
    #btnAttachFileSubfolder {
      font-size: 20px; margin: 10px 3px; background: #fff; border: none; color: #aaa;
      border-radius: 6px; padding: 5px 10px; cursor: pointer; transition: background-color 0.2s;
    }
    #btnAttachFileSubfolder:hover { background-color: #eee; }
    #fileInputSubfolder { display: none; }
    .attachment-icon {
      font-size: 20px; margin-left: 5px; cursor: pointer;
    }
    #documentListScreen {
      display: none; padding: 20px; position: relative; width: 100%; box-sizing: border-box;
    }
    #documentList {
      margin-top: 5px; display: flex; flex-direction: column; gap: 10px;
    }
    .doc-item {
      background-color: #ffffff; border: 1px solid #ddd; border-radius: 8px; padding: 10px 15px; cursor: pointer;
      transition: background-color 0.3s; font-size: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      position: relative; padding-right: 70px; display: flex; justify-content: space-between; align-items: center;
    }
    .doc-favorited { background-color: #b0bec5 !important; }
    .doc-item:hover { background-color: #e0e0e0; }
    .doc-item-title { font-weight: bold; margin-bottom: 5px; }
    .doc-item-subject {
      font-size: 14px; color: #666; white-space: pre-wrap; margin-left: 20px; position: relative;
    }
    .doc-subject-bullet {
      position: absolute; left: -15px; top: 0; color: #666; cursor: pointer; font-weight: bold;
    }
    .doc-summary {
      display: none; margin-top: 5px; padding-left: 20px; font-size: 14px; color: #666;
      border-left: 2px solid #ccc; position: relative;
    }
    .summary-actions {
      margin-top: 4px; font-size: 12px; color: #666;
    }
    .summary-actions span { margin-right: 8px; cursor: pointer; text-decoration: underline; }
    .document-header {
      display: flex; flex-direction: column; align-items: center; margin-bottom: 10px;
    }
    #documentTotalCount {
      text-align: right; font-size: 14px; color: #555; margin-top: 10px;
    }
    #documentCompletionPercent {
      font-size: 24px; font-weight: bold; margin-left: 10px; position: relative; cursor: default;
      display: inline-block; background: rgba(255,200,200,0.3); color: #333; padding: 5px 10px; border-radius: 6px;
    }
    #btnAttachFileDoc {
      font-size: 20px; margin: 10px 3px; background: #fff; border: none; color: #aaa;
      border-radius: 6px; padding: 5px 10px; cursor: pointer; transition: background-color 0.2s;
    }
    #btnAttachFileDoc:hover { background-color: #eee; }
    #fileInputDoc { display: none; }
    .doc-attachment-icon {
      font-size: 20px; margin-left: 5px; cursor: pointer;
    }
    #documentDetailScreen {
      display: none; position: relative; width: 100%; box-sizing: border-box; margin-top: 0; padding-top: 0;
    }
    #documentDetailScreen .detail-header {
      display: flex; align-items: center; justify-content: space-between; padding: 0 10px; margin-bottom: 10px;
    }
    #documentDetailScreen .nav-buttons { display: flex; gap: 20px; }
    #documentDetailScreen .add-custom-folder {
      display: flex; align-items: center;
    }
    #documentDetailScreen .add-custom-folder button#addCustomFolderBtn {
      font-size: 24px; padding: 5px;
    }
    #documentDetailScreen .add-custom-folder button.calendar-btn {
      margin-left: 5px;
    }
    #customFoldersContainer {
      margin-top: 20px; display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; margin: 0 auto;
    }
    .custom-folder-item {
      flex: 1 1 120px; max-width: 150px; height: auto; display: flex; flex-direction: column; align-items: center; justify-content: center;
      border: 1px solid #ddd; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      background-color: #e0e0e0; font-size: 16px; text-align: center; transition: background-color 0.3s; position: relative;
    }
    .custom-folder-item:hover { background-color: #f5f5f5; }
    .custom-folder-item div:last-child {
      font-size: 12px; color: #333; margin-top: 4px;
    }
    .custom-context-menu, .context-menu-folder, .context-menu-subfolder,
    .context-menu-doc, .context-menu-background {
      position: absolute; background-color: #ffffff; border: 1px solid #ddd; box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 9999; display: none; border-radius: 6px;
    }
    .custom-context-menu ul, .context-menu-folder ul, .context-menu-subfolder ul,
    .context-menu-doc ul, .context-menu-background ul {
      list-style: none; margin: 0; padding: 0;
    }
    .custom-context-menu li, .context-menu-folder li, .context-menu-subfolder li,
    .context-menu-doc li, .context-menu-background li {
      padding: 10px 20px; cursor: pointer; transition: background-color 0.2s;
    }
    .custom-context-menu li:hover, .context-menu-folder li:hover, .context-menu-subfolder li:hover,
    .context-menu-doc li:hover, .context-menu-background li:hover {
      background-color: #f1f1f1;
    }
    .context-menu-custom-folder {
      position: absolute; background-color: #ffffff; border: 1px solid #ddd; box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 9999; display: none; border-radius: 6px;
    }
    .context-menu-custom-folder ul { list-style: none; margin: 0; padding: 0; }
    .context-menu-custom-folder li { padding: 10px 20px; cursor: pointer; transition: background-color 0.2s; }
    .context-menu-custom-folder li:hover { background-color: #f1f1f1; }
    .submenu { position: relative; }
    .submenu > ul {
      position: absolute; top: 0; left: 100%; background-color: #ffffff; border: 1px solid #ddd; box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      padding: 10px 0; display: none; border-radius: 6px; min-width: 150px; z-index: 1001;
    }
    .submenu:hover > ul { display: block; }
    .submenu::after {
      content: '▶'; position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
      font-size: 12px; color: #555;
    }
    .context-menu-file {
      position: absolute; background-color: #ffffff; border: 1px solid #ddd; box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 9999; display: none; border-radius: 6px;
    }
    .context-menu-file ul { list-style: none; margin: 0; padding: 0; }
    .context-menu-file li { padding: 10px 20px; cursor: pointer; transition: background-color 0.2s; }
    .context-menu-file li:hover { background-color: #f1f1f1; }
    .calendar-btn {
      opacity: 0.7; transition: opacity 0.2s; font-size: 20px; padding: 4px 8px;
    }
    .calendar-btn:hover { opacity: 1; }
    .modal {
      display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%;
      overflow: auto; background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: #fff; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      width: 600px; height: 600px; overflow-y: auto; border-radius: 8px; padding: 20px; text-align: center;
    }
    #calendarModal td {
      text-align: center !important; vertical-align: middle !important; padding: 8px !important;
    }
    #editorSection {
      display: none; position: relative; width: 100%; min-height: 70vh; margin: 20px auto; padding: 40px 20px 20px;
      box-sizing: border-box; background-color: #f4f4f4;
    }
    #editorTitle {
      background-color: #fff; padding: 15px; margin-bottom: 10px; border-bottom: 1px solid #ddd;
      font-size: 22px; font-weight: bold; border-radius: 8px; text-align: center; display: none;
    }
    .input-area {
      background-color: #ffffff; padding: 20px; border-bottom: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .editable-div {
      width: 100%; height: 120px; padding: 10px 15px; border: 1px solid #ccc; border-radius: 6px;
      font-size: 16px; line-height: 1.5; resize: vertical; overflow-y: auto; transition: border-color 0.3s; margin-bottom: 10px;
    }
    .editable-div:focus {
      outline: none; border-color: #007BFF; box-shadow: 0 0 5px rgba(0,123,255,0.5);
    }
    .editor-container {
      flex: 1; padding: 20px 0; display: flex; flex-direction: column; gap: 0; overflow-y: auto; position: relative;
    }
    .box {
      background-color: #f0f0f0; border: 1px solid #ddd; border-radius: 8px; min-height: 45px; position: relative;
      display: flex; align-items: center; padding: 0.02px 15px; font-size: 16px; transition: background-color 0.3s, height 0.3s, border-color 0.3s;
      cursor: text; width: 100%; margin-bottom: 0; overflow: visible; white-space: normal; box-sizing: border-box; text-align: left !important;
      justify-content: flex-start !important;
    }
    .box a {
      display: block !important; text-align: center !important; width: 100% !important; pointer-events: auto !important;
    }
    .box * { margin-top: 0; margin-bottom: 0; }
    .box.selected { border: 2px solid #007BFF; }
    .box:hover { border-color: #007BFF; }
    .box:focus-within {
      border-color: #007BFF; box-shadow: 0 0 5px rgba(0,123,255,0.3); background-color: #e6f2ff;
    }
    #bottomButtonsContainer {
      display: flex; justify-content: center; align-items: center; gap: 20px; margin: 10px 0;
    }
    #bottomButtonsContainer div {
      cursor: pointer; font-size: 24px; padding: 5px 10px; border-radius: 6px; background: #fff; color: #aaa;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center;
    }
    #bottomButtonsContainer div:hover { background-color: #eee; color: #555; }
    .custom-context-menu {
      position: absolute; background-color: #ffffff; border: 1px solid #ddd; box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 9999; display: none; border-radius: 6px;
    }
    .custom-context-menu ul { list-style: none; margin: 0; padding: 0; }
    .custom-context-menu li { padding: 10px 20px; cursor: pointer; transition: background-color 0.2s; }
    .custom-context-menu li:hover { background-color: #f1f1f1; }
    button {
      margin-right: 10px; padding: 10px 15px; font-size: 14px; cursor: pointer; border: none; border-radius: 5px;
      background-color: #007BFF; color: #fff;
    }
    button:hover { background-color: #0056b3; }
    #editorNavigation {
      position: absolute; top: -20px; left: 50%; transform: translateX(-50%); z-index: 10; display: flex; gap: 20px;
    }
    .centered-link-container {
      text-align: center !important; width: 100%; display: block !important; flex: none !important;
      min-height: 45px; line-height: 45px;
    }
    .modal.calendar-modal { }
    .modal.calendar-modal .modal-content {
      background-color: #ffffff; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 600px;
      height: auto; overflow: visible; padding: 20px; font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
    }
    #closeCalendarBtn {
      position: absolute; top: 10px; right: 10px; font-size: 20px; cursor: pointer; background: none; border: none; color: #333;
    }
    #eventCountdown {
      margin-bottom: 15px; font-size: 16px; color: #333;
    }
    #calendarHeader {
      background-color: #0078D7; color: #fff; padding: 10px; border-radius: 6px; font-size: 24px; text-align: center; margin-bottom: 10px;
    }
    #calendarNav { text-align: center; margin-bottom: 10px; }
    #calendarNav button {
      background-color: transparent; border: none; color: #0078D7; font-size: 16px; padding: 5px 10px; cursor: pointer;
    }
    #calendarNav button:hover { text-decoration: underline; }
    #currentCalendar table { margin: 0 auto; border-collapse: collapse; }
    #currentCalendar thead th {
      background-color: #f3f3f3; padding: 5px 8px; font-weight: bold; border: 1px solid #ddd;
    }
    #currentCalendar tbody td {
      padding: 5px; border: 1px solid #ddd; cursor: pointer; width: 35px; height: 35px; text-align: center; vertical-align: middle;
    }
    #currentCalendar tbody td:hover { background-color: #eaeaea; }
    @keyframes blinkingAlert {
      0%, 100% { box-shadow: 0 0 6px 4px rgba(255, 0, 0, 0.8); }
      50% { box-shadow: none; }
    }
    .blinking-alert { animation: blinkingAlert 1.2s infinite; }
    .alert-red { background-color: red !important; }
    .box:not([style*="flex-direction: column"]) {
      display: flex !important; height: 45px !important; align-items: center !important; justify-content: flex-start !important;
      line-height: 45px !important; padding-top: 0 !important; padding-bottom: 0 !important;
    }
    .box:not([style*="flex-direction: column"]) * {
      margin: 0 !important; padding: 0 !important; vertical-align: middle !important;
    }
    .modal-fullscreen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8);
      display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000;
    }
    .modal-fullscreen .modal-content {
      background-color: #fff; padding: 10px 20px 20px; border-radius: 8px;
      width: 100%; height: 100%; overflow-y: auto; position: relative;
    }
    .modal-fullscreen .modal-close-btn {
      position: absolute; top: 10px; right: 10px; font-size: 24px; color: #000; background: transparent; border: none; cursor: pointer; z-index: 2100;
    }
    .file-title {
      position: absolute; top: 10px; left: 10px; font-size: 12px; color: #333; text-align: left; max-width: 50%; word-break: break-all;
    }
    #customTooltip {
      position: absolute; background-color: #f9f9f9; color: #000; padding: 8px 12px; border: 1px solid #ccc;
      border-radius: 6px; font-size: 14px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); display: none; z-index: 2000; white-space: normal;
    }
    .context-menu-custom-folder {
      position: absolute; background-color: #ffffff; border: 1px solid #ddd; box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 9999; display: none; border-radius: 6px;
    }
    .context-menu-custom-folder ul { list-style: none; margin: 0; padding: 0; }
    .context-menu-custom-folder li { padding: 10px 20px; cursor: pointer; transition: background-color 0.2s; }
    .context-menu-custom-folder li:hover { background-color: #f1f1f1; }
  </style>
</head>
<body>

  <!-- (SEUS ELEMENTOS DE TELA DE LOGIN, REGISTRO, PASTAS, SUBPASTAS ETC.) -->
  <!-- Conteúdo HTML EXATAMENTE como no seu código (nada alterado) -->

  <!-- ========================================
       SCRIPT (Firebase + Lógica + Editor)
  ========================================-->
  <script type="module">
    import { openDB } from 'https://unpkg.com/idb?module';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc
    } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-firestore.js";

    // ================================
    // IndexedDB (igual ao seu)
    // ================================
    const dbPromise = openDB('myAppDB', 1, {
      upgrade(db) {
        if (!db.objectStoreNames.contains('userData')) {
          db.createObjectStore('userData', { keyPath: 'id' });
        }
      }
    });
    async function saveAllDataLocal(data) {
      const db = await dbPromise;
      await db.put('userData', { id: 'default', ...data });
    }
    async function loadAllDataLocal() {
      const db = await dbPromise;
      const result = await db.get('userData', 'default');
      return result || {};
    }

    // ================================
    // Config do Firebase (igual ao seu)
    // ================================
    const firebaseConfig = {
      apiKey: "AIzaSyDNLcuknXeyddvqAVtul6RCOMVrlfwJQPo",
      authDomain: "sistema-b8c6c.firebaseapp.com",
      projectId: "sistema-b8c6c",
      storageBucket: "sistema-b8c6c.firebasestorage.app",
      messagingSenderId: "661126236594",
      appId: "1:661126236594:web:f18abb296d9ba7cc6ebcab"
    };
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // ================================
    // Variáveis globais (iguais às suas)
    // ================================
    let folders          = [];
    let folderSubfolders = {};
    let namedDocuments   = [];
    let folderEvents     = {};
    let copyBuffer       = null;
    let currentUserUid   = null;

    let currentFolder     = null;
    let currentSubFolder  = null;
    let currentDocName    = null;
    let currentDocSubject = null;
    let currentDocument   = null;

    let currentCustomFolderId = null;
    let selectedCustomFolderType = null;

    let favoriteFolders    = {};
    let favoriteSubfolders = {};
    let folderFiles        = {};

    let folderPage = 0;
    const foldersPerPage = Number.MAX_SAFE_INTEGER;
    let customFolderPage = 0;
    const customFoldersPerPage = Number.MAX_SAFE_INTEGER;

    let currentCalendarMonth = null;
    let currentCalendarYear  = null;

    const pieColors = [
      "#f38ca5", "#9edaa5", "#fff08c", "#a1b1ec", "#fac198",
      "#c88fda", "#a3f8f8", "#f899f3", "#defb86", "#fddfdf",
      "#80c0c0", "#f3dfff", "#cdb192", "#fffde4", "#c08080",
      "#d5ffe1", "#c0c080", "#ffecd8", "#8080ba", "#c0c0c0"
    ];

    // ================================
    // Função loadAllData(uid) [NOVO]
    // ================================
    async function loadAllData(uid) {
      // 1) Carrega local
      const localData = await loadAllDataLocal();

      // 2) Se tivermos uid, busca no Firestore
      let remoteData = null;
      if (uid) {
        const userRef = doc(db, "users", uid);
        const snap = await getDoc(userRef);
        if (snap.exists()) {
          remoteData = snap.data();
        }
      }

      // 3) Mescla local com remoto (exemplo: remoto sobrescreve local)
      let finalData = { ...localData };
      if (remoteData) {
        finalData = { ...finalData, ...remoteData };
      }

      // 4) Atualiza variáveis globais
      folders                    = finalData.folders || [];
      folderSubfolders           = finalData.folderSubfolders || {};
      namedDocuments             = finalData.namedDocuments || [];
      favoriteFolders            = finalData.favoriteFolders || {};
      favoriteSubfolders         = finalData.favoriteSubfolders || {};
      folderEvents               = finalData.folderEvents || {};
      window.completedSubfolders = finalData.completedSubfolders || {};
      folderFiles                = finalData.folderFiles || {};

      // 5) Salva novamente local para manter tudo igual
      await saveAllDataLocal(finalData);

      // 6) Exibe a tela principal
      showFolderScreen();
    }

    // ================================
    // Função saveAllData() [ATUALIZADA]
    // ================================
    async function saveAllData() {
      const data = {
        folders,
        folderSubfolders,
        namedDocuments,
        favoriteFolders,
        favoriteSubfolders,
        folderEvents,
        completedSubfolders: window.completedSubfolders,
        folderFiles
      };
      // Salva local
      await saveAllDataLocal(data);

      // Se estiver logado, salva no Firestore também
      if (currentUserUid) {
        const userRef = doc(db, "users", currentUserUid);
        await setDoc(userRef, data, { merge: true });
      }
    }

    // ================================
    // Observa se o usuário logou/deslogou
    // ================================
    onAuthStateChanged(auth, async (user) => {
      if(user){
        currentUserUid = user.uid;
        loginScreen.style.display    = "none";
        registerScreen.style.display = "none";

        // Carrega dados do IndexedDB + Firestore
        await loadAllData(user.uid);

        // Exibe a tela de pastas
        document.getElementById("folderScreen").style.display = "block";
      } else {
        currentUserUid = null;
        loginScreen.style.display                 = "block";
        registerScreen.style.display              = "none";
        document.getElementById("folderScreen").style.display       = "none";
        document.getElementById("subFolderScreen").style.display    = "none";
        document.getElementById("documentListScreen").style.display = "none";
        document.getElementById("documentDetailScreen").style.display= "none";
        document.getElementById("editorSection").style.display       = "none";
      }
    });

    // ================================
    // Botão de Logout
    // ================================
    const logoutBtn = document.getElementById("logoutBtn") || null;
    if(logoutBtn){
      logoutBtn.addEventListener("click", async function(){
        try {
          await signOut(auth);
        } catch (error) {
          console.error("Erro ao deslogar:", error);
        }
      });
    }

    // ================================
    // Login e Registro [iguais]
    // ================================
    const loginScreen    = document.getElementById("loginScreen");
    const registerScreen = document.getElementById("registerScreen");
    const goRegisterLink = document.getElementById("goRegisterLink");
    const goLoginLink    = document.getElementById("goLoginLink");
    const loginBtn       = document.getElementById("loginBtn");
    const registerBtn    = document.getElementById("registerBtn");

    goRegisterLink.addEventListener("click", (e) => {
      e.preventDefault();
      loginScreen.style.display = "none";
      registerScreen.style.display = "block";
    });
    if(goLoginLink){
      goLoginLink.addEventListener("click", (e) => {
        e.preventDefault();
        registerScreen.style.display = "none";
        loginScreen.style.display = "block";
      });
    }

    loginBtn.addEventListener("click", async () => {
      const email = document.getElementById("emailInput").value;
      const pass  = document.getElementById("passwordInput").value;
      if(!email || !pass){ alert("Informe email e senha."); return; }
      try {
        await signInWithEmailAndPassword(auth, email, pass);
      } catch(err){ alert("Erro ao logar: " + err.message); }
    });
    registerBtn.addEventListener("click", async () => {
      const email = document.getElementById("regEmailInput").value;
      const pass  = document.getElementById("regPasswordInput").value;
      if(!email || !pass){ alert("Informe email e senha para cadastro."); return; }
      try {
        await createUserWithEmailAndPassword(auth, email, pass);
      } catch(err){ alert("Erro ao cadastrar: " + err.message); }
    });

    // ================================
    // Daqui para baixo, NADA mudou
    // (todas as suas funções e lógicas)
    // ================================
    
    // ... (TODAS as suas funções EXACTAS: showFolderScreen, showSubFolderScreen, etc.)
    // ... (SEM alterar nada, apenas usando as novas loadAllData / saveAllData quando for salvar/ler)

    // (Copia e cola TODO o restante do seu script
    //  exatamente como estava, sem mudar nada
    //  EXCETO por remover as versões antigas de loadAllData() e saveAllData(),
    //  já que agora temos as novas acima.)

    // >>> DAQUI PRA BAIXO JÁ ESTÁ EM SEU ARQUIVO:
    // function showFolderScreen() { ... }
    // function enterFolder(...) { ... }
    // function parseMultipleEntries(...) { ... }
    // function showSubFolderScreen(...) { ... }
    // function showDocumentList(...) { ... }
    // function createNewDocument(...) { ... }
    // function updateDocumentCompletionPercent(...) { ... }
    // function renderCurrentDocumentCustomFolders(...) { ... }
    // function loadDocumentDetailScreen(...) { ... }
    // function loadCustomFolderEditor(...) { ... }
    // ... e assim por diante ...
    
  </script>
</body>
</html>
