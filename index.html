<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Sistema com Editor Estilo Excel + Firebase</title>

  <style>
    /* ========================================
       Normalização para evitar rolagem extra 
       e garantir que tudo seja box-sizing: border-box
    ========================================*/
    html, body {
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
      overflow-x: hidden; /* Evita rolagem horizontal */
    }
    * {
      box-sizing: inherit; 
    }

    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Lato:wght@300&display=swap');

    /* ===================== ESTILOS GERAIS E BODY ===================== */
    body {
      padding: 20px;
      background-color: #f4f4f4;
      font-family: 'Lato', sans-serif;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: flex-start;
      height: 100vh;
      text-align: left;
      position: relative;
    }

    /* ===================== TELA DE LOGIN (NOVO LAYOUT) ===================== */
    #loginScreen {
      display: flex;
      flex-direction: column;
      width: 100%;
      height: 100%;
      position: relative;
    }
    .header {
      display: flex;
      align-items: center;
    }
    .logo-container {
      display: flex;
      align-items: center;
    }
    .logo-icon {
      width: 50px;
      height: 50px;
      background-color: #007BFF;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-right: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    .logo-icon::after {
      content: '\1F310'; /* Ícone de globo */
      font-size: 24px;
      color: white;
    }
    .logo {
      font-family: 'Montserrat', sans-serif;
      font-weight: 900;
      font-size: 48px;
      letter-spacing: 3px;
      color: #007BFF;
      text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
      position: relative;
    }
    .slogan {
      font-family: 'Lato', sans-serif;
      font-weight: 300;
      font-size: 18px;
      color: #666;
      margin-top: 20px;
      text-align: left;
      padding-left: 80px;
    }

    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      width: 420px;
      margin: auto;
      margin-top: 60px; /* Para subir/descer o quadradinho de login */
    }
    .access-text {
      font-family: 'Montserrat', sans-serif;
      font-weight: 700;
      font-size: 20px;
      color: #333;
      text-align: center;
      margin-bottom: 20px;
    }
    .login-form {
      display: flex;
      flex-direction: column;
    }
    .login-form input {
      font-family: 'Lato', sans-serif;
      font-size: 16px;
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .login-form button {
      font-family: 'Lato', sans-serif;
      font-size: 16px;
      background-color: #007BFF;
      color: white;
      border: none;
      padding: 12px;
      border-radius: 5px;
      cursor: pointer;
    }
    .login-form button:hover {
      background-color: #0056b3;
    }
    .register {
      font-size: 14px;
      margin-top: 15px;
      text-align: center;
    }
    .register a {
      color: #007BFF;
      text-decoration: none;
    }

    .info-box {
      position: absolute;
      top: 180px;
      right: 50px;
      font-size: 18px;
      font-weight: 400;
      color: #333;
      text-align: left;
    }
    .info-box div {
      margin-bottom: 15px;
    }
    .highlight-text {
      font-family: 'Montserrat', sans-serif;
      font-size: 20px;
      font-weight: 700;
      color: #007BFF;
      margin-top: 30px;
    }

    /* ===================== TELA DE REGISTRO ===================== */
    #registerScreen {
      display: none;
      text-align: center;
      padding: 20px;
      width: 100%;
      box-sizing: border-box;
    }

    /* ===================== TELA DE PASTAS ===================== */
    #folderScreen {
      display: none;
      padding: 20px;
      position: relative;
      width: 100%;
      box-sizing: border-box; /* Para caber bem na tela, sem overflow */
    }
    .page-title {
      background-color: #fff;
      padding: 15px;
      margin-bottom: 10px;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 22px;
      font-weight: bold;
      border-radius: 8px;
    }
    .folder-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      position: relative;
    }
    .nav-buttons {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      width: 100%;
      margin: 10px 0;
      flex-wrap: wrap; /* Para não estourar a tela */
    }
    .plus-button {
      border: none;
      background: #fff;
      color: #aaa;
      font-size: 28px;
      border-radius: 6px;
      padding: 5px 10px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .plus-button:hover { background-color: #eee; }
    .nav-button {
      font-size: 28px;
      border: none;
      background: #fff;
      border-radius: 6px;
      padding: 5px 10px;
      cursor: pointer;
      color: #aaa;
      transition: background-color 0.2s;
      min-width: 60px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .nav-button:hover {
      background-color: #eee;
      color: #777;
    }
    #folderList {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      margin-top: 20px;
      width: 100%;
    }
    .folder-item {
      width: 100px;
      height: 120px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      background-color: #e0e0e0;
      border: 1px solid #ddd;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s;
      font-size: 16px;
      position: relative;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .folder-item:hover { background-color: #f5f5f5; }
    .folder-icon {
      font-size: 40px;
      margin-top: 10px;
    }
    .folder-name {
      margin-top: 5px;
      padding: 0 5px;
      font-size: 14px;
      line-height: 1.2;
      word-wrap: break-word;
      font-weight: bold;
    }

    /* ===================== TELA DE SUBPASTAS ===================== */
    #subFolderScreen {
      display: none;
      padding: 20px;
      position: relative;
      width: 100%;
      box-sizing: border-box;
    }
    #subFolderList {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .subfolder-item {
      background-color: #e0e0e0;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px 15px;
      cursor: pointer;
      transition: background-color 0.3s;
      font-size: 16px;
      font-weight: bold;
      position: relative;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .subfolder-item:hover { background-color: #f5f5f5; }

    /* ===================== TELA DE DOCUMENTOS ===================== */
    #documentListScreen {
      display: none;
      padding: 20px;
      position: relative;
      width: 100%;
      box-sizing: border-box;
    }
    #documentList {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .doc-item {
      background-color: #ffffff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px 15px;
      cursor: pointer;
      transition: background-color 0.3s;
      font-size: 16px;
      position: relative;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .doc-item:hover { background-color: #e0e0e0; }
    .doc-item-title {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .doc-item-subject {
      font-size: 14px;
      color: #666;
      white-space: pre-wrap;
      margin-left: 20px;
      position: relative;
    }
    .doc-item-subject::before {
      content: "- ";
      position: absolute;
      left: -15px;
    }
    .document-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 10px;
      position: relative;
    }

    /* ===================== TELA DO EDITOR ===================== */
    #editorSection {
      display: none;
      width: 100%;
      box-sizing: border-box;
      min-height: 70vh; 
      margin-top: 0; /* <--- ALTERADO aqui para ficar mais próximo do topo */
      margin-bottom: 20px;
    }

    /* Barra superior do editor (input-area) */
    .input-area {
      background-color: #ffffff;
      padding: 20px;
      border-bottom: 1px solid #ddd;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .editable-div {
      width: 100%;
      height: 120px;
      padding: 10px 15px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
      line-height: 1.5;
      resize: vertical;
      overflow-y: auto;
      transition: border-color 0.3s;
    }
    .editable-div:focus {
      outline: none;
      border-color: #007BFF;
      box-shadow: 0 0 5px rgba(0,123,255,0.5);
    }

    /* Container flexível onde ficam os blocos de texto (.box) */
    .editor-container {
      flex: 1;
      padding: 20px 0;
      display: flex;
      flex-direction: column;
      gap: 0;
      overflow-y: auto;  /* Para rolagem dos blocos */
    }
    /* Cada bloco do editor */
    .editor-container .box {
      background-color: #f0f0f0;
      border: 1px solid #ddd;
      border-radius: 8px;
      height: 45px;
      display: flex;
      align-items: center;
      padding: 0 15px;
      font-size: 16px;
      transition: background-color 0.3s, height 0.3s, border-color 0.3s;
      cursor: text;
      position: relative;
      width: 100%;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    .editor-container .box.colored {
      height: 50px;
      background-color: #e6f2ff;
    }
    .editor-container .box:focus-within {
      border-color: #007BFF;
      box-shadow: 0 0 5px rgba(0,123,255,0.3);
      background-color: #e6f2ff;
    }
    .editor-container .box:hover {
      border-color: #007BFF;
    }

    /* ===================== MENUS DE CONTEXTO E OUTRAS CLASSES ===================== */
    .custom-context-menu,
    .context-menu-folder,
    .context-menu-subfolder,
    .context-menu-doc,
    .context-menu-background {
      position: absolute;
      background-color: #ffffff;
      border: 1px solid #ddd;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 9999;
      display: none;
      border-radius: 6px;
    }
    .custom-context-menu ul,
    .context-menu-folder ul,
    .context-menu-subfolder ul,
    .context-menu-doc ul,
    .context-menu-background ul {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    .custom-context-menu li,
    .context-menu-folder li,
    .context-menu-subfolder li,
    .context-menu-doc li,
    .context-menu-background li {
      padding: 10px 20px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .custom-context-menu li:hover,
    .context-menu-folder li:hover,
    .context-menu-subfolder li:hover,
    .context-menu-doc li:hover,
    .context-menu-background li:hover {
      background-color: #f1f1f1;
    }
    .submenu { position: relative; }
    .submenu > ul {
      position: absolute;
      top: 0;
      left: 100%;
      background-color: #ffffff;
      border: 1px solid #ddd;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      padding: 10px 0;
      display: none;
      border-radius: 6px;
      min-width: 150px;
      z-index: 1001;
    }
    .submenu:hover > ul {
      display: block;
    }
    .submenu::after {
      content: '▶';
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 12px;
      color: #555;
    }

    /* ===================== PROGRESS OVERLAY ===================== */
    .progress-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5);
      display: flex; flex-direction: column;
      justify-content: center; align-items: center;
      z-index: 2000;
    }
    .progress-container {
      width: 80%; max-width: 400px;
      background-color: #fff; border-radius: 10px;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      text-align: center;
    }
    .progress-bar {
      width: 100%; height: 20px; background-color: #ddd; border-radius: 10px; overflow: hidden;
    }
    .progress-fill {
      width: 0%; height: 100%; background-color: #007BFF;
    }

    /* ===================== RESPONSIVIDADE ===================== */
    @media (max-width: 600px) {
      .editable-div, 
      .editor-container .box {
        font-size: 14px;
      }
      .custom-context-menu {
        width: 180px;
      }
      .submenu > ul {
        min-width: 120px;
      }
      /* Ajustes para inputs e botões do login */
      .login-form input {
        width: 90%;
      }
      .page-title {
        font-size: 18px;
        padding: 10px;
      }
      .plus-button {
        font-size: 24px;
        padding: 5px;
      }
      .nav-button {
        font-size: 24px;
        padding: 5px 8px;
        min-width: 50px;
      }
      .folder-item,
      .doc-item,
      .subfolder-item {
        width: 80px;
        height: 100px;
        font-size: 14px;
      }
      #folderList, #subFolderList, #documentList {
        gap: 10px;
      }
      #loginScreen,
      #registerScreen,
      #folderScreen,
      #subFolderScreen,
      #documentListScreen {
        padding: 10px;
      }
    }
  </style>
</head>
<body>

  <!-- ===================== TELA DE LOGIN (NOVO VISUAL) ===================== -->
  <div id="loginScreen">
    <div class="header">
      <div class="logo-container">
        <div class="logo-icon"></div>
        <div class="logo">Sistema</div>
      </div>
    </div>
    <div class="slogan">Todas suas informações integradas em um só lugar</div>

    <!-- Quadradinho de login com "Acesse e aproveite" no topo -->
    <div class="container">
      <div class="access-text">Acesse e aproveite</div>
      <form class="login-form" onsubmit="return false;">
        <input type="email"    id="emailInput"    placeholder="Seu e-mail">
        <input type="password" id="passwordInput" placeholder="Sua senha">
        <button id="loginBtn">Entrar</button>
      </form>
      <div class="register">Não tem conta? <a href="#" id="goRegisterLink">Cadastrar</a></div>
    </div>

    <div class="info-box">
      <div>📚 Concursos</div>
      <div>🎓 Faculdade</div>
      <div>💼 Trabalho</div>
      <div>📂 Dados pessoais</div>
      <div class="highlight-text">E muitos mais<br> Tudo em um só lugar. 🎉</div>
    </div>
  </div>

  <!-- ===================== TELA DE REGISTRO ===================== -->
  <div id="registerScreen">
    <h2>Cadastrar</h2>
    <input type="email" id="regEmailInput" placeholder="Seu e-mail"><br>
    <input type="password" id="regPasswordInput" placeholder="Sua senha"><br><br>
    <button id="registerBtn">Cadastrar</button>
    <p>Já tem conta? <a href="#" id="goLoginLink">Fazer login</a></p>
  </div>

  <!-- ===================== TELA DE PASTAS ===================== -->
  <div id="folderScreen">
    <div class="page-title" id="folderScreenTitle">Painel inicial</div>
    <div class="folder-header">
      <button id="createFolderBtn" class="plus-button">+</button>
      <div class="nav-buttons">
        <button class="nav-button" id="folderLeftArrow" title="Voltar (início)">&larr;</button>
        <button class="nav-button" id="folderRightArrow" title="Avançar (não há avançar)">&rarr;</button>
      </div>
      <button id="logoutBtn" class="plus-button">Sair</button>
    </div>
    <div id="folderList"></div>
  </div>

  <!-- ===================== TELA DE SUBPASTAS ===================== -->
  <div id="subFolderScreen">
    <div class="page-title" id="subFolderTitle"></div>
    <div class="nav-buttons">
      <button class="nav-button" id="subFolderLeftArrow"  title="Voltar para Pastas">&larr;</button>
      <button class="nav-button" id="subFolderRightArrow" title="Não há tela seguinte">&rarr;</button>
    </div>
    <button id="btnCreateSubFolder" class="plus-button">+</button>
    <div id="subFolderList"></div>
  </div>

  <!-- ===================== TELA DE DOCUMENTOS ===================== -->
  <div id="documentListScreen">
    <div class="page-title">
      <div id="documentListTitle"></div>
    </div>
    <div class="nav-buttons">
      <button class="nav-button" id="docLeftArrow"  title="Voltar">&larr;</button>
      <button class="nav-button" id="docRightArrow" title="Não há avanço">&rarr;</button>
    </div>
    <button id="btnCreateDoc" class="plus-button">+</button>
    <div id="createDocumentForm">
      <label for="docNameInput">Nome do Documento:</label>
      <input type="text" id="docNameInput" placeholder="Ex: Relatório 2025" />
      <label for="docSubjectInput">Assunto:</label>
      <input type="text" id="docSubjectInput" placeholder="Ex: Análise de Custos..." />
      <button id="createNewDocBtn">Criar</button>
    </div>
    <div id="documentList"></div>
  </div>

  <!-- ===================== TELA DO EDITOR ===================== -->
  <div id="editorSection">
    <!-- Título opcional do Editor (pode deixar display:none se quiser) -->
    <div class="page-title" id="editorTitle" style="display:none;">Editor</div>

    <!-- Barra superior com input de texto e botões -->
    <div class="input-area" id="inputArea">
      <div class="editable-div" id="textInput" contenteditable="true" placeholder="Cole seu texto aqui..."></div>
      <button id="generateTextBtn">Gerar Texto</button>
      <button id="loadLastBtn" style="margin-left:10px;">&#x21BA; Último Documento</button>
    </div>

    <!-- Botões de navegação (Esquerda/ Direita) -->
    <div class="nav-buttons">
      <button class="nav-button" id="editorLeftArrow"  title="Voltar para documentos">&larr;</button>
      <button class="nav-button" id="editorRightArrow" title="Nenhum avanço">&rarr;</button>
    </div>

    <!-- Área flexível para exibir os blocos. Repare na classe .editor-container -->
    <div id="textContainer" class="editor-container"></div>

    <!-- Menu de contexto do Editor -->
    <div class="custom-context-menu" id="contextMenu">
      <ul>
        <li id="copyBlock">Copiar Bloco</li>
        <li id="deleteBlock">Excluir Bloco</li>
        <li id="centerImageInsideBlock">Centralizar Imagem no Bloco</li>
        <li class="submenu">Alterar Tamanho da Fonte
          <ul>
            <li data-font-size="14px">14px</li>
            <li data-font-size="16px">16px</li>
            <li data-font-size="18px">18px</li>
            <li data-font-size="20px">20px</li>
            <li data-font-size="22px">22px</li>
          </ul>
        </li>
        <li class="submenu">Alterar Cor da Linha
          <ul>
            <li data-color="#f0f0f0">Cinza Claro</li>
            <li data-color="#00B050">Verde</li>
            <li data-color="#FFC000">Amarelo</li>
            <li data-color="#00B0F0">Azul</li>
            <li data-color="#00C0C0">Turquesa</li>
            <li data-color="#F79646">Laranja</li>
            <li data-color="#FF00FF">Magenta</li>
            <li data-color="#00FF00">Verde Vibrante</li>
            <li data-color="#FFFF00">Amarelo Vibrante</li>
            <li data-color="#FF69B4">Rosa Shock</li>
          </ul>
        </li>
      </ul>
    </div>
  </div>

  <!-- ===================== MENUS DE CONTEXTO (Folder, Subfolder, Doc, BG) ===================== -->
  <div class="context-menu-folder" id="contextMenuFolder">
    <ul>
      <li id="copyFolderItem">Copiar Pasta</li>
      <li id="pasteIntoFolder" style="display:none;">Colar aqui</li>
      <li id="editFolderItem">Renomear Pasta</li>
      <li id="deleteFolderItem">Excluir Pasta</li>
    </ul>
  </div>
  <div class="context-menu-subfolder" id="contextMenuSubFolder">
    <ul>
      <li id="copySubFolderItem">Copiar Subpasta</li>
      <li id="pasteIntoSubFolder" style="display:none;">Colar aqui</li>
      <li id="editSubFolderItem">Renomear Subpasta</li>
      <li id="deleteSubFolderItem">Excluir Subpasta</li>
    </ul>
  </div>
  <div class="context-menu-doc" id="contextMenuDoc">
    <ul>
      <li id="copyDocItem">Copiar Documento</li>
      <li id="editDocItem">Renomear Documento</li>
      <li id="deleteDocItem">Excluir Documento</li>
    </ul>
  </div>
  <div class="context-menu-background" id="contextMenuBackground">
    <ul>
      <li id="pasteItem">Colar</li>
    </ul>
  </div>

  <!-- ===================== SCRIPT (Firebase + Lógica) ===================== -->
  <script type="module">
    /*
      Import das bibliotecas via CDN Firebase (versão 9.17.2)
    */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
    import { getAuth,
             createUserWithEmailAndPassword,
             signInWithEmailAndPassword,
             onAuthStateChanged,
             signOut } 
      from "https://www.gstatic.com/firebasejs/9.17.2/firebase-auth.js";
    import { getFirestore,
             doc,
             getDoc,
             setDoc }
      from "https://www.gstatic.com/firebasejs/9.17.2/firebase-firestore.js";

    /*
      Config do projeto "sistema-b8c6c" (exatamente como fornecido)
    */
    const firebaseConfig = {
      apiKey: "AIzaSyDNLcuknXeyddvqAVtul6RCOMVrlfwJQPo",
      authDomain: "sistema-b8c6c.firebaseapp.com",
      projectId: "sistema-b8c6c",
      storageBucket: "sistema-b8c6c.firebasestorage.app",
      messagingSenderId: "661126236594",
      appId: "1:661126236594:web:f18abb296d9ba7cc6ebcab"
    };

    // Inicializa Firebase
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    /* ===================== VARIÁVEIS GLOBAIS (MEMÓRIA) ===================== */
    let folders          = [];            
    let folderSubfolders = {};           
    let namedDocuments   = [];           
    let copyBuffer       = null;         
    let currentUserUid   = null;

    // Onde estamos
    let currentFolder     = null;
    let currentSubFolder  = null;
    let currentDocName    = null;
    let currentDocSubject = null;

    // Função para chamada ao ChatGPT (não utilizada, pois a opção Explicar foi removida)
    async function callChatGPT(promptText) {
      const apiKey = "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";
      const endpoint = "https://api.openai.com/v1/chat/completions";
      const requestBody = {
        model: "gpt-3.5-turbo",
        messages: [
          { role: "system", content: "Você é um assistente que responde de forma objetiva e clara." },
          { role: "user",   content: promptText }
        ],
        temperature: 0.7
      };
      const response = await fetch(endpoint, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${apiKey}`
        },
        body: JSON.stringify(requestBody)
      });
      const data = await response.json();
      if(data.error) {
        console.error("Erro da API OpenAI:", data.error);
        throw new Error(data.error.message);
      }
      return data.choices?.[0]?.message?.content || "Não foi possível obter resposta do ChatGPT.";
    }

    /* ===================== ELEMENTOS DE LOGIN/REGISTRO ===================== */
    const loginScreen    = document.getElementById("loginScreen");
    const registerScreen = document.getElementById("registerScreen");
    const goRegisterLink = document.getElementById("goRegisterLink");
    const goLoginLink    = document.getElementById("goLoginLink");
    const loginBtn       = document.getElementById("loginBtn");
    const registerBtn    = document.getElementById("registerBtn");
    const logoutBtn      = document.getElementById("logoutBtn") || null;

    goRegisterLink.addEventListener("click",(e)=>{
      e.preventDefault();
      loginScreen.style.display = "none";
      registerScreen.style.display = "block";
    });
    if(goLoginLink){
      goLoginLink.addEventListener("click",(e)=>{
        e.preventDefault();
        registerScreen.style.display = "none";
        loginScreen.style.display    = "block";
      });
    }

    loginBtn.addEventListener("click", async ()=>{
      const email = document.getElementById("emailInput").value;
      const pass  = document.getElementById("passwordInput").value;
      if(!email || !pass){
        alert("Informe email e senha.");
        return;
      }
      try {
        await signInWithEmailAndPassword(auth, email, pass);
        console.log("Login ok!");
      } catch(err){
        alert("Erro ao logar: " + err.message);
      }
    });
    registerBtn.addEventListener("click", async ()=>{
      const email = document.getElementById("regEmailInput").value;
      const pass  = document.getElementById("regPasswordInput").value;
      if(!email || !pass){
        alert("Informe email e senha para cadastro.");
        return;
      }
      try {
        await createUserWithEmailAndPassword(auth, email, pass);
        console.log("Cadastro ok!");
      } catch(err){
        alert("Erro ao cadastrar: " + err.message);
      }
    });

    onAuthStateChanged(auth, async (user)=>{
      if(user){
        currentUserUid = user.uid;
        console.log("Logado como:", user.uid);
        // Oculta telas de login/cadastro
        loginScreen.style.display    = "none";
        registerScreen.style.display = "none";
        // Carrega dados do Firestore
        await loadAllData(user.uid);
        // Exibe tela de pastas
        document.getElementById("folderScreen").style.display = "block";
      } else {
        console.log("Ninguém logado");
        currentUserUid = null;
        // Volta pra tela de login
        loginScreen.style.display         = "block";
        registerScreen.style.display      = "none";
        document.getElementById("folderScreen").style.display       = "none";
        document.getElementById("subFolderScreen").style.display    = "none";
        document.getElementById("documentListScreen").style.display = "none";
        document.getElementById("editorSection").style.display      = "none";
      }
    });

    if(logoutBtn){
      logoutBtn.addEventListener("click", async ()=>{
        await signOut(auth);
        console.log("Deslogado!");
      });
    }

    /* ===================== CARREGAR E SALVAR NO FIRESTORE ===================== */
    async function loadAllData(uid){
      const ref = doc(db, "userData", uid);
      const snap= await getDoc(ref);
      if(snap.exists()){
        const data = snap.data();
        folders          = data.folders          || [];
        folderSubfolders = data.folderSubfolders || {};
        namedDocuments   = data.namedDocuments   || [];
      } else {
        folders          = [];
        folderSubfolders = {};
        namedDocuments   = [];
      }
      console.log("Dados carregados do Firestore.");
      showFolderScreen();
    }
    async function saveAllData(){
      if(!currentUserUid) return;
      await showSavingOverlay(); 
      const ref = doc(db, "userData", currentUserUid);
      await setDoc(ref, {
        folders,
        folderSubfolders,
        namedDocuments
      });
      console.log("Dados salvos no Firestore.");
    }

    /* ===================== TELA DE PASTAS ===================== */
    const folderScreen    = document.getElementById("folderScreen");
    const folderList      = document.getElementById("folderList");
    const createFolderBtn = document.getElementById("createFolderBtn");
    const folderLeftArrow = document.getElementById("folderLeftArrow");
    const folderRightArrow= document.getElementById("folderRightArrow");

    folderLeftArrow.addEventListener("click", () => { showFolderScreen(); });
    folderRightArrow.addEventListener("click", () => { alert("Não há tela seguinte."); });
    createFolderBtn.addEventListener("click", () => { createFolder(); });

    function showFolderScreen(){
      folderScreen.style.display       = "block";
      document.getElementById("subFolderScreen").style.display    = "none";
      document.getElementById("documentListScreen").style.display = "none";
      document.getElementById("editorSection").style.display      = "none";

      currentFolder     = null;
      currentSubFolder  = null;
      currentDocName    = null;
      currentDocSubject = null;

      folderList.innerHTML = "";
      if(folders.length === 0){
        const msg = document.createElement("div");
        msg.textContent = "Nenhuma pasta criada ainda.";
        folderList.appendChild(msg);
      } else {
        folders.forEach(folderName =>{
          const folderItem = document.createElement("div");
          folderItem.classList.add("folder-item");
          const icon = document.createElement("div");
          icon.classList.add("folder-icon");
          icon.textContent = "📂";
          folderItem.appendChild(icon);

          const nameDiv = document.createElement("div");
          nameDiv.classList.add("folder-name");
          nameDiv.textContent = folderName;
          folderItem.appendChild(nameDiv);

          folderItem.onclick = ()=> enterFolder(folderName);
          folderItem.addEventListener("contextmenu",(e)=>{
            e.preventDefault();
            showContextMenuFolder(e.pageX, e.pageY, folderName);
          });
          folderList.appendChild(folderItem);
        });
      }
    }
    function createFolder(){
      const folderName = prompt("Nome da nova pasta:");
      if(!folderName) return;
      if(folders.includes(folderName)){
        alert("Já existe uma pasta com esse nome.");
        return;
      }
      folders.push(folderName);
      if(!folderSubfolders[folderName]){
        folderSubfolders[folderName] = [];
      }
      saveAllData();
      showFolderScreen();
    }
    function enterFolder(folderName){
      currentFolder = folderName;
      showSubFolderScreen(folderName);
    }

    /* ===================== TELA DE SUBPASTAS ===================== */
    const subFolderScreen     = document.getElementById("subFolderScreen");
    const subFolderList       = document.getElementById("subFolderList");
    const subFolderTitle      = document.getElementById("subFolderTitle");
    const subFolderLeftArrow  = document.getElementById("subFolderLeftArrow");
    const subFolderRightArrow = document.getElementById("subFolderRightArrow");
    const btnCreateSubFolder  = document.getElementById("btnCreateSubFolder");

    subFolderLeftArrow.addEventListener("click", ()=>{
      showFolderScreen();
    });
    subFolderRightArrow.addEventListener("click", ()=>{
      alert("Não há tela seguinte.");
    });
    btnCreateSubFolder.addEventListener("click", ()=>{
      if(!currentFolder) return;
      createSubFolder(currentFolder);
    });

    function showSubFolderScreen(folderName){
      folderScreen.style.display       = "none";
      subFolderScreen.style.display    = "block";
      document.getElementById("documentListScreen").style.display = "none";
      document.getElementById("editorSection").style.display      = "none";

      currentFolder = folderName;
      subFolderTitle.textContent = folderName;

      const subs = folderSubfolders[folderName] || [];
      subFolderList.innerHTML = "";

      if(subs.length === 0){
        const msg = document.createElement("div");
        msg.textContent = "Não há subpastas nesta pasta.";
        subFolderList.appendChild(msg);
      } else {
        subs.forEach(subName =>{
          const item = document.createElement("div");
          item.classList.add("subfolder-item");
          item.textContent = subName;
          item.onclick = ()=> showDocumentList(folderName, subName);
          item.addEventListener("contextmenu",(e)=>{
            e.preventDefault();
            showContextMenuSubFolder(e.pageX, e.pageY, subName);
          });
          subFolderList.appendChild(item);
        });
      }
    }
    function createSubFolder(folderName){
      const subName = prompt("Nome da subpasta em '"+folderName+"':");
      if(!subName) return;
      if(!folderSubfolders[folderName]) folderSubfolders[folderName] = [];
      if(folderSubfolders[folderName].includes(subName)){
        alert("Já existe essa subpasta.");
        return;
      }
      folderSubfolders[folderName].push(subName);
      saveAllData();
      showSubFolderScreen(folderName);
    }

    /* ===================== TELA DE DOCUMENTOS ===================== */
    const documentListScreen = document.getElementById("documentListScreen");
    const documentListTitle  = document.getElementById("documentListTitle");
    const documentList       = document.getElementById("documentList");
    const btnCreateDoc       = document.getElementById("btnCreateDoc");
    const docLeftArrow       = document.getElementById("docLeftArrow");
    const docRightArrow      = document.getElementById("docRightArrow");
    const createDocumentForm = document.getElementById("createDocumentForm");
    const docNameInput       = document.getElementById("docNameInput");
    const docSubjectInput    = document.getElementById("docSubjectInput");
    const createNewDocBtn    = document.getElementById("createNewDocBtn");

    docLeftArrow.addEventListener("click", () => {
      showSubFolderScreen(currentFolder);
    });
    docRightArrow.addEventListener("click", () => {
      alert("Não há tela seguinte.");
    });
    btnCreateDoc.addEventListener("click", () => {
      createDocumentForm.style.display = (createDocumentForm.style.display === "none") ? "block" : "none";
      docNameInput.value    = "";
      docSubjectInput.value = "";
    });
    createNewDocBtn.addEventListener("click", () => {
      createNewDocument();
    });

    function showDocumentList(folderName, subFolderName){
      currentFolder     = folderName;
      currentSubFolder  = subFolderName || null;
      folderScreen.style.display       = "none";
      subFolderScreen.style.display    = "none";
      documentListScreen.style.display = "block";
      document.getElementById("editorSection").style.display = "none";

      documentList.innerHTML           = "";
      createDocumentForm.style.display = "none";

      if(subFolderName){
        documentListTitle.textContent = folderName + " / " + subFolderName;
      } else {
        documentListTitle.textContent = folderName;
      }

      const docs = namedDocuments.filter(d =>
        d.folderName === folderName &&
        (d.subFolderName||null) === (subFolderName||null)
      );
      if(docs.length === 0){
        const msg = document.createElement("div");
        msg.textContent = "Não há documentos aqui.";
        documentList.appendChild(msg);
      } else {
        docs.forEach(doc => {
          const docItem = document.createElement("div");
          docItem.classList.add("doc-item");

          const docTitle = document.createElement("div");
          docTitle.classList.add("doc-item-title");
          docTitle.textContent = doc.name;

          const docSub = document.createElement("div");
          docSub.classList.add("doc-item-subject");
          docSub.textContent = doc.subject || "";

          docItem.appendChild(docTitle);
          docItem.appendChild(docSub);

          docItem.onclick = () => loadDocumentInEditor(doc.name, doc.subject, folderName, subFolderName);
          docItem.addEventListener("contextmenu",(e)=>{
            e.preventDefault();
            showContextMenuDoc(e.pageX, e.pageY, doc.name);
          });

          documentList.appendChild(docItem);
        });
      }
    }
    function createNewDocument(){
      const docName = docNameInput.value.trim();
      const docSub  = docSubjectInput.value.trim();
      if(!docName){
        alert("Informe um nome para o documento.");
        return;
      }
      // Verifica se já existe doc com mesmo nome
      const conflict = namedDocuments.find(d =>
        d.folderName===currentFolder &&
        (d.subFolderName||null)===(currentSubFolder||null) &&
        d.name===docName
      );
      if(conflict){
        alert("Já existe um documento com esse nome nesta pasta/subpasta.");
        return;
      }
      namedDocuments.push({
        folderName: currentFolder,
        subFolderName: currentSubFolder || null,
        name: docName,
        subject: docSub,
        content: ""
      });
      saveAllData();
      docNameInput.value    = "";
      docSubjectInput.value = "";
      createDocumentForm.style.display = "none";
      showDocumentList(currentFolder, currentSubFolder);
    }
    function loadDocumentInEditor(docName, docSubject, folderName, subFolderName){
      const docObj = namedDocuments.find(d =>
        d.folderName===folderName &&
        (d.subFolderName||null)===(subFolderName||null) &&
        d.name===docName
      );
      if(!docObj){
        alert("Documento não encontrado.");
        return;
      }
      currentFolder     = folderName;
      currentSubFolder  = subFolderName||null;
      currentDocName    = docName;
      currentDocSubject = docSubject||"";

      documentListScreen.style.display = "none";
      document.getElementById("editorSection").style.display = "block";
      
      /* Limpa / recria os blocos no editor */
      const textContainer = document.getElementById("textContainer");
      textContainer.innerHTML = docObj.content;

      const boxes = textContainer.querySelectorAll(".box");
      boxes.forEach(box => {
        box.setAttribute("contenteditable","true");
        initBlockEvents(box);
        autoCenterElements(box);
      });

      // Se estava vazio, mostra input-area
      if(docObj.content.trim() === ""){
        document.getElementById("inputArea").style.display = "block";
        document.getElementById("textInput").focus();
      } else {
        document.getElementById("inputArea").style.display = "none";
      }

      addAddButton();
    }

    /* ===================== EDITOR (BLOCOS E EVENTOS) ===================== */
    const editorSection   = document.getElementById("editorSection");
    const textInput       = document.getElementById("textInput");
    const generateTextBtn = document.getElementById("generateTextBtn");
    const loadLastBtn     = document.getElementById("loadLastBtn");
    const editorLeftArrow = document.getElementById("editorLeftArrow");
    const editorRightArrow= document.getElementById("editorRightArrow");

    editorLeftArrow.addEventListener("click", ()=>{
      showDocumentList(currentFolder, currentSubFolder);
    });
    editorRightArrow.addEventListener("click", ()=>{
      alert("Não há tela seguinte.");
    });

    generateTextBtn.addEventListener("click", ()=> processText());
    loadLastBtn.addEventListener("click", ()=>{
      alert("Exemplo: Carregar último doc ainda não está implementado.");
    });

    function processText(){
      document.getElementById("inputArea").style.display = "none";
      const htmlContent = textInput.innerHTML.trim();
      const temp = document.createElement("div");
      temp.innerHTML = htmlContent;
      const childNodes = Array.from(temp.childNodes);
      const container = document.getElementById("textContainer");

      childNodes.forEach(node => {
        if(node.nodeType === Node.ELEMENT_NODE ||
           (node.nodeType === Node.TEXT_NODE && node.textContent.trim() !== "")){
          createEditableBox(node.outerHTML || node.textContent, container);
        }
      });
      textInput.innerHTML = "";
      addAddButton();
    }
    function createEditableBox(content, container){
      const box = document.createElement("div");
      box.classList.add("box");
      box.setAttribute("contenteditable", "true");
      box.innerHTML = content;
      box.style.backgroundColor = "#f0f0f0"; // cor inicial
      box.style.fontSize = "16px";
      box.setAttribute('data-color-index','0');

      capitalizeFirstLetter(box);
      autoCenterElements(box);
      initBlockEvents(box);
      container.appendChild(box);
      return box;
    }
    function initBlockEvents(box){
      // Ao dar duplo clique, a paleta de cores agora possui todas as cores da opção "Alterar Cor da Linha"
      box.addEventListener("dblclick", function(){
        const palette = ["#f0f0f0", "#00B050", "#FFC000", "#00B0F0", "#00C0C0", "#F79646", "#FF00FF", "#00FF00", "#FFFF00", "#FF69B4"];
        let colorIndex = parseInt(box.getAttribute("data-color-index") || 0);
        colorIndex = (colorIndex + 1) % palette.length;
        box.setAttribute("data-color-index", colorIndex);
        box.style.backgroundColor = palette[colorIndex];
      });

      box.addEventListener("keydown", function(e){
        if(e.key === "Enter" && !e.shiftKey){
          e.preventDefault();
          const container = document.getElementById("textContainer");
          const range = window.getSelection().getRangeAt(0);
          const rangeClone = range.cloneRange();
          rangeClone.selectNodeContents(box);
          rangeClone.setStart(range.endContainer, range.endOffset);
          const afterContent = rangeClone.extractContents();
          const newBox = createEditableBox("", container);
          newBox.appendChild(afterContent);
          container.insertBefore(newBox, box.nextSibling);
          newBox.focus();
          capitalizeFirstLetter(newBox);
          autoCenterElements(newBox);
        }
      });
      box.addEventListener("contextmenu", function(e){
        e.preventDefault();
        showEditorContextMenu(e.pageX, e.pageY, box);
      });
      box.addEventListener("input", function(){
        capitalizeFirstLetter(box);
        autoCenterElements(box);
      });
      box.addEventListener("paste", function(e){
        e.preventDefault();
        const cd = e.clipboardData || window.clipboardData;
        const text = cd.getData("text/html") || cd.getData("text/plain");
        if(cd.files && cd.files.length > 0){
          // Colando arquivo/imagem
          const file = cd.files[0];
          const reader = new FileReader();
          reader.onload = function(ev){
            const img = document.createElement("img");
            img.src = ev.target.result;
            img.alt = "Imagem colada";
            img.style.display = "block";
            img.style.margin = "0 auto";
            img.style.maxWidth = "700px";
            img.style.height = "auto";
            const sel = window.getSelection();
            if(sel.rangeCount){
              const rng = sel.getRangeAt(0);
              rng.deleteContents();
              rng.insertNode(img);
              rng.collapse(false);
            } else {
              document.execCommand("insertHTML", false, img.outerHTML);
            }
            box.style.height = "auto";
            box.style.overflow = "visible";
            box.style.whiteSpace = "normal";
            box.style.alignItems = "center";
            box.style.justifyContent = "center";
            box.style.padding = "10px";
            box.style.flexDirection = "column";
            autoCenterElements(box);
          };
          reader.readAsDataURL(file);
        } else {
          document.execCommand("insertHTML", false, text);
        }
      });
    }
    function capitalizeFirstLetter(box){
      const walker = document.createTreeWalker(box, NodeFilter.SHOW_TEXT, null, false);
      let textNode = walker.nextNode();
      while(textNode){
        const txt = textNode.nodeValue.trim();
        if(txt.length > 0){
          const first = txt.charAt(0);
          const upper = first.toUpperCase();
          if(first !== upper){
            textNode.nodeValue = upper + textNode.nodeValue.slice(1);
          }
          break; 
        }
        textNode = walker.nextNode();
      }
    }
    function autoCenterElements(box){
      const imgs = box.querySelectorAll("img");
      const tables = box.querySelectorAll("table");
      if(imgs.length>0 || tables.length>0){
        box.style.height = "auto";
        box.style.overflow = "visible";
        box.style.whiteSpace = "normal";
        box.style.alignItems = "center";
        box.style.justifyContent = "center";
        box.style.padding = "10px";
        box.style.flexDirection = "column";
        imgs.forEach(img => {
          img.style.display = "block";
          img.style.marginLeft = "auto";
          img.style.marginRight = "auto";
          img.style.maxWidth = "700px";
          img.style.height = "auto";
        });
        tables.forEach(tbl => {
          tbl.style.marginLeft = "auto";
          tbl.style.marginRight = "auto";
          tbl.style.width = "auto";
        });
      } else {
        box.style.height = "45px";
        box.style.overflow = "hidden";
        box.style.whiteSpace = "nowrap";
        box.style.alignItems = "center";
        box.style.justifyContent = "flex-start";
        box.style.padding = "0 15px";
        box.style.flexDirection = "row";
      }
    }

    /* Botões “+”, “Salvar”, etc. no editor */
    function addAddButton(){
      const container = document.getElementById("textContainer");
      const old = document.getElementById("buttonContainer");
      if(old) old.remove();

      const buttonContainer = document.createElement("div");
      buttonContainer.id = "buttonContainer";
      buttonContainer.style.display = "flex";
      buttonContainer.style.justifyContent = "center";
      buttonContainer.style.alignItems = "center";
      buttonContainer.style.gap = "20px";
      buttonContainer.style.margin = "10px 0";

      const addButton = document.createElement("div");
      addButton.textContent = "+";
      addButton.style.cursor = "pointer";
      addButton.style.fontSize = "24px";
      addButton.style.padding = "5px";
      addButton.style.borderRadius = "6px";
      addButton.style.background = "#fff";
      addButton.style.color = "#aaa";
      addButton.style.boxShadow = "0 2px 4px rgba(0,0,0,0.1)";
      addButton.title = "Adicionar novo bloco de texto/imagem";
      addButton.addEventListener("click", () => {
        buttonContainer.remove();
        document.getElementById("inputArea").style.display = "block";
        textInput.focus();
      });

      const saveButton = document.createElement("div");
      saveButton.textContent = "💾";
      saveButton.style.cursor = "pointer";
      saveButton.style.fontSize = "24px";
      saveButton.style.padding = "5px";
      saveButton.style.borderRadius = "6px";
      saveButton.style.background = "#fff";
      saveButton.style.color = "#aaa";
      saveButton.style.boxShadow = "0 2px 4px rgba(0,0,0,0.1)";
      saveButton.title = "Salvar alterações neste documento";
      saveButton.addEventListener("click", () => {
        if(currentDocName){
          saveDocumentNamed(currentDocName, currentDocSubject || "");
        } else {
          alert("Este documento não tem nome. Use 'Salvar com nome' para escolher um nome.");
        }
      });

      const saveWithName = document.createElement("div");
      saveWithName.textContent = "💾🖉";
      saveWithName.style.cursor = "pointer";
      saveWithName.style.fontSize = "24px";
      saveWithName.style.padding = "5px";
      saveWithName.style.borderRadius = "6px";
      saveWithName.style.background = "#fff";
      saveWithName.style.color = "#aaa";
      saveWithName.style.boxShadow = "0 2px 4px rgba(0,0,0,0.1)";
      saveWithName.title = "Salvar como (nome e assunto)";
      saveWithName.addEventListener("click", () => {
        saveDocumentWithName();
      });

      const loadButton = document.createElement("div");
      loadButton.textContent = "📂";
      loadButton.style.cursor = "pointer";
      loadButton.style.fontSize = "24px";
      loadButton.style.padding = "5px";
      loadButton.style.borderRadius = "6px";
      loadButton.style.background = "#fff";
      loadButton.style.color = "#aaa";
      loadButton.style.boxShadow = "0 2px 4px rgba(0,0,0,0.1)";
      loadButton.title = "Carregar documento salvo";
      loadButton.addEventListener("click", () => {
        loadDocumentByName();
      });

      buttonContainer.appendChild(addButton);
      buttonContainer.appendChild(saveButton);
      buttonContainer.appendChild(saveWithName);
      buttonContainer.appendChild(loadButton);
      container.appendChild(buttonContainer);
    }
    function saveDocumentNamed(docName, docSubject){
      if(!currentFolder){
        alert("Escolha uma pasta antes de salvar.");
        return;
      }
      const textContainer = document.getElementById("textContainer");
      const containerClone = textContainer.cloneNode(true);
      const buttonContainerClone = containerClone.querySelector("#buttonContainer");
      if(buttonContainerClone) buttonContainerClone.remove();

      const docIndex = namedDocuments.findIndex(d =>
        d.folderName === currentFolder &&
        (d.subFolderName||null) === (currentSubFolder||null) &&
        d.name === docName
      );
      if(docIndex >= 0){
        namedDocuments[docIndex].subject = docSubject;
        namedDocuments[docIndex].content = containerClone.innerHTML;
      } else {
        namedDocuments.push({
          folderName: currentFolder,
          subFolderName: currentSubFolder || null,
          name: docName,
          subject: docSubject,
          content: containerClone.innerHTML
        });
      }
      saveAllData();
    }
    function saveDocumentWithName(){
      if(!currentFolder){
        alert("Escolha uma pasta antes de salvar.");
        return;
      }
      let newName;
      let newSubject;
      if(currentDocName){
        newName = prompt("Nome do documento:", currentDocName);
        if(newName===null) return;
        if(!newName.trim()){
          alert("Nome inválido.");
          return;
        }
        newSubject = prompt("Assunto:", currentDocSubject || "");
        if(newSubject===null) newSubject="";
      } else {
        newName = prompt("Nome do documento:");
        if(!newName) return;
        newSubject = prompt("Assunto:") || "";
      }
      currentDocName    = newName;
      currentDocSubject = newSubject;
      saveDocumentNamed(newName, newSubject);
    }
    function loadDocumentByName(){
      if(!currentFolder){
        alert("Escolha uma pasta antes de carregar documentos.");
        return;
      }
      const docs = namedDocuments.filter(d =>
        d.folderName === currentFolder &&
        (d.subFolderName||null) === (currentSubFolder||null)
      );
      if(docs.length===0){
        alert("Não há documentos salvos nesta pasta/subpasta.");
        return;
      }
      let listStr = `Documentos em "${currentFolder}"`;
      if(currentSubFolder) listStr += ` / "${currentSubFolder}"`;
      listStr += ":\n\n";
      docs.forEach((doc, i) => {
        listStr += `${i+1}. ${doc.name} (Assunto: ${doc.subject||"nenhum"})\n`;
      });
      listStr += "\nDigite o número do doc ou clique em Cancelar.";
      const choice = prompt(listStr);
      if(choice===null) return;
      const idx = parseInt(choice,10)-1;
      if(isNaN(idx)||idx<0||idx>=docs.length){
        alert("Opção inválida.");
        return;
      }
      const chosen = docs[idx];
      loadDocumentInEditor(chosen.name, chosen.subject, chosen.folderName, chosen.subFolderName);
    }

    /* ===================== PROGRESS OVERLAY (SALVANDO) ===================== */
    function showSavingOverlay(){
      return new Promise(resolve => {
        const overlay = document.createElement("div");
        overlay.classList.add("progress-overlay");
        const container = document.createElement("div");
        container.classList.add("progress-container");
        const progressText = document.createElement("div");
        progressText.style.marginBottom = "10px";
        progressText.innerText = "Salvando: 0%";

        const progressBar = document.createElement("div");
        progressBar.classList.add("progress-bar");
        const progressFill = document.createElement("div");
        progressFill.classList.add("progress-fill");
        progressBar.appendChild(progressFill);

        container.appendChild(progressText);
        container.appendChild(progressBar);
        overlay.appendChild(container);
        document.body.appendChild(overlay);

        let simulated = 0;
        const int1 = setInterval(() => {
          if(simulated < 90){
            simulated += Math.random() * 5;
            if(simulated > 90) simulated = 90;
            progressFill.style.width = simulated + "%";
            progressText.innerText = "Salvando: " + Math.floor(simulated) + "%";
          }
        }, 200);

        setTimeout(() => {
          clearInterval(int1);
          let int2 = setInterval(() => {
            simulated += 5;
            if(simulated >= 100){
              simulated = 100;
              progressFill.style.width = "100%";
              progressText.innerText = "Salvando: 100%";
              clearInterval(int2);
              progressText.innerText = "Documento salvo!";
              setTimeout(() => {
                document.body.removeChild(overlay);
                resolve();
              }, 700);
            } else {
              progressFill.style.width = simulated + "%";
              progressText.innerText = "Salvando: " + Math.floor(simulated) + "%";
            }
          }, 100);
        }, 1500);
      });
    }

    /* ===================== MENUS DE CONTEXTO (FOLDERS, SUBFOLDERS, DOCS) ===================== */
    document.addEventListener("click", (e)=>{
      const mF  = document.getElementById("contextMenuFolder");
      const mSF = document.getElementById("contextMenuSubFolder");
      const mD  = document.getElementById("contextMenuDoc");
      const mBg = document.getElementById("contextMenuBackground");
      const mE  = document.getElementById("contextMenu");
      if(mF.style.display==="block") mF.style.display="none";
      if(mSF.style.display==="block") mSF.style.display="none";
      if(mD.style.display==="block") mD.style.display="none";
      if(mBg.style.display==="block") mBg.style.display="none";
      if(mE.style.display==="block") mE.style.display="none";
    });

    /* ========== MENU DE CONTEXTO DE PASTA ========== */
    function showContextMenuFolder(x,y,folderName){
      const menuFolder = document.getElementById("contextMenuFolder");
      menuFolder.style.display="block";
      menuFolder.style.left = x + "px";
      menuFolder.style.top  = y + "px";
      menuFolder.targetFolder = folderName;
      document.getElementById("pasteIntoFolder").style.display = copyBuffer ? "block":"none";
    }
    document.getElementById("copyFolderItem").addEventListener("click", ()=>{
      const f = document.getElementById("contextMenuFolder").targetFolder;
      copyFolder(f);
      document.getElementById("contextMenuFolder").style.display="none";
    });
    document.getElementById("pasteIntoFolder").addEventListener("click", ()=>{
      if(!copyBuffer){
        alert("Nada copiado.");
        return;
      }
      pasteIntoThisFolder(document.getElementById("contextMenuFolder").targetFolder);
      document.getElementById("contextMenuFolder").style.display="none";
    });
    document.getElementById("editFolderItem").addEventListener("click", ()=>{
      const oldName = document.getElementById("contextMenuFolder").targetFolder;
      const newName = prompt("Renomear pasta:", oldName);
      if(newName && newName!==oldName){
        renameFolder(oldName, newName);
      }
      document.getElementById("contextMenuFolder").style.display="none";
    });
    document.getElementById("deleteFolderItem").addEventListener("click", ()=>{
      const f = document.getElementById("contextMenuFolder").targetFolder;
      if(confirm(`Excluir pasta "${f}"?`)){
        deleteFolder(f);
      }
      document.getElementById("contextMenuFolder").style.display="none";
    });

    function copyFolder(folderName){
      const subs = folderSubfolders[folderName] || [];
      const docs = namedDocuments.filter(d => d.folderName===folderName);
      copyBuffer = {
        type: "folder",
        name: folderName,
        subfolders: JSON.parse(JSON.stringify(subs)),
        docs: JSON.parse(JSON.stringify(docs))
      };
      alert(`Pasta "${folderName}" copiada. Você pode colar na tela inicial (vazia).`);
    }
    function pasteIntoThisFolder(folderName){
      if(copyBuffer.type==="folder"){
        alert("Não suportamos colar uma Pasta dentro de outra (sub-subpastas não implementadas).");
        return;
      }
      else if(copyBuffer.type==="subfolder"){
        if(!folderSubfolders[folderName]) folderSubfolders[folderName]=[];
        let arr = folderSubfolders[folderName];
        let newName = copyBuffer.name;
        let count=1;
        while(arr.includes(newName)){
          newName = copyBuffer.name + " (Cópia" + (count>1?" "+count:"") + ")";
          count++;
        }
        arr.push(newName);
        folderSubfolders[folderName]=arr;
        copyBuffer.docs.forEach(d=>{
          let docName = d.name;
          let docCount = 1;
          let conflict = namedDocuments.find(x=>
            x.folderName===folderName &&
            (x.subFolderName||null)===newName &&
            x.name===docName
          );
          while(conflict){
            docName = d.name + " (Cópia" + (docCount>1?" "+docCount:"") + ")";
            docCount++;
            conflict = namedDocuments.find(x=>
              x.folderName===folderName &&
              (x.subFolderName||null)===newName &&
              x.name===docName
            );
          }
          namedDocuments.push({
            folderName,
            subFolderName:newName,
            name:docName,
            subject:d.subject,
            content:d.content
          });
        });
        alert(`Subpasta "${copyBuffer.name}" colada como "${newName}" em "${folderName}".`);
        saveAllData();
        showFolderScreen();
      }
      else if(copyBuffer.type==="document"){
        let docName = copyBuffer.name;
        let docCount=1;
        let conflict = namedDocuments.find(x=>
          x.folderName===folderName &&
          (x.subFolderName||null)===null &&
          x.name===docName
        );
        while(conflict){
          docName=copyBuffer.name + " (Cópia" + (docCount>1?" "+docCount:"") + ")";
          docCount++;
          conflict = namedDocuments.find(x=>
            x.folderName===folderName &&
            (x.subFolderName||null)===null &&
            x.name===docName
          );
        }
        namedDocuments.push({
          folderName,
          subFolderName:null,
          name:docName,
          subject: copyBuffer.subject || "",
          content: copyBuffer.content
        });
        alert(`Documento "${copyBuffer.name}" colado como "${docName}" em "${folderName}".`);
        saveAllData();
        showFolderScreen();
      }
    }
    function renameFolder(oldName, newName){
      if(folders.includes(newName)){
        alert("Já existe pasta com esse nome.");
        return;
      }
      folders = folders.map(f => f===oldName?newName:f);
      if(folderSubfolders[oldName] !== undefined){
        folderSubfolders[newName] = folderSubfolders[oldName];
        delete folderSubfolders[oldName];
      }
      namedDocuments.forEach(d=>{
        if(d.folderName===oldName){
          d.folderName=newName;
        }
      });
      saveAllData();
      showFolderScreen();
    }
    function deleteFolder(folderName){
      folders = folders.filter(f => f!==folderName);
      delete folderSubfolders[folderName];
      namedDocuments = namedDocuments.filter(d=>d.folderName!==folderName);
      saveAllData();
      showFolderScreen();
    }

    /* ========== MENU DE CONTEXTO DE SUBPASTA ========== */
    function showContextMenuSubFolder(x,y,subFolderName){
      const menuSubFolder = document.getElementById("contextMenuSubFolder");
      menuSubFolder.style.display="block";
      menuSubFolder.style.left=x+"px";
      menuSubFolder.style.top =y+"px";
      menuSubFolder.targetSubFolder = subFolderName;
      document.getElementById("pasteIntoSubFolder").style.display = copyBuffer?"block":"none";
    }
    document.getElementById("copySubFolderItem").addEventListener("click", ()=>{
      copySubFolder(currentFolder, document.getElementById("contextMenuSubFolder").targetSubFolder);
      document.getElementById("contextMenuSubFolder").style.display="none";
    });
    document.getElementById("pasteIntoSubFolder").addEventListener("click", ()=>{
      if(!copyBuffer){
        alert("Nada copiado.");
        return;
      }
      pasteIntoThisSubFolder(currentFolder, document.getElementById("contextMenuSubFolder").targetSubFolder);
      document.getElementById("contextMenuSubFolder").style.display="none";
    });
    document.getElementById("editSubFolderItem").addEventListener("click", ()=>{
      const oldSub = document.getElementById("contextMenuSubFolder").targetSubFolder;
      const newSub = prompt("Renomear subpasta:", oldSub);
      if(newSub && newSub!==oldSub){
        renameSubFolder(currentFolder, oldSub, newSub);
      }
      document.getElementById("contextMenuSubFolder").style.display="none";
    });
    document.getElementById("deleteSubFolderItem").addEventListener("click", ()=>{
      const subName = document.getElementById("contextMenuSubFolder").targetSubFolder;
      if(confirm(`Excluir subpasta "${subName}"?`)){
        deleteSubFolder(currentFolder, subName);
      }
      document.getElementById("contextMenuSubFolder").style.display="none";
    });

    function copySubFolder(folderName, subFolderName){
      const docsInSub = namedDocuments.filter(d=>
        d.folderName===folderName && d.subFolderName===subFolderName
      );
      copyBuffer = {
        type:"subfolder",
        name:subFolderName,
        folderName,
        docs: JSON.parse(JSON.stringify(docsInSub))
      };
      alert(`Subpasta "${subFolderName}" copiada. Vá até outra Pasta e clique com direito para colar.`);
    }
    function pasteIntoThisSubFolder(folderName, subFolderName){
      if(copyBuffer.type==="document"){
        let docName = copyBuffer.name;
        let docCount = 1;
        let conflict = namedDocuments.find(x=>
          x.folderName===folderName &&
          (x.subFolderName||null)===subFolderName &&
          x.name===docName
        );
        while(conflict){
          docName = docName + " (Cópia" + (docCount>1?" "+docCount:"") + ")";
          docCount++;
          conflict = namedDocuments.find(x=>
            x.folderName===folderName &&
            (x.subFolderName||null)===subFolderName &&
            x.name===docName
          );
        }
        namedDocuments.push({
          folderName,
          subFolderName,
          name: docName,
          subject: copyBuffer.subject||"",
          content: copyBuffer.content
        });
        alert(`Documento "${copyBuffer.name}" colado como "${docName}" em "${folderName}/${subFolderName}".`);
        saveAllData();
        showSubFolderScreen(folderName);
      } else {
        alert("Não suportamos colar Pasta/Subpasta dentro de Subpasta (sub-subpastas não implementadas).");
      }
    }
    function renameSubFolder(folderName, oldSub, newSub){
      let subs = folderSubfolders[folderName]||[];
      if(subs.includes(newSub)){
        alert("Já existe subpasta com esse nome.");
        return;
      }
      subs = subs.map(s=>s===oldSub?newSub:s);
      folderSubfolders[folderName] = subs;
      namedDocuments.forEach(d=>{
        if(d.folderName===folderName && d.subFolderName===oldSub){
          d.subFolderName=newSub;
        }
      });
      saveAllData();
      showSubFolderScreen(folderName);
    }
    function deleteSubFolder(folderName, subFolderName){
      let subs = folderSubfolders[folderName]||[];
      subs = subs.filter(s=>s!==subFolderName);
      folderSubfolders[folderName] = subs;
      namedDocuments = namedDocuments.filter(d=>
        !(d.folderName===folderName && d.subFolderName===subFolderName)
      );
      saveAllData();
      showSubFolderScreen(folderName);
    }

    /* ========== MENU DE CONTEXTO DE DOCUMENTO ========== */
    function showContextMenuDoc(x,y,docName){
      const menuDoc = document.getElementById("contextMenuDoc");
      menuDoc.style.display="block";
      menuDoc.style.left = x+"px";
      menuDoc.style.top  = y+"px";
      menuDoc.targetDocName = docName;
    }
    document.getElementById("copyDocItem").addEventListener("click", ()=>{
      copyDoc(document.getElementById("contextMenuDoc").targetDocName);
      document.getElementById("contextMenuDoc").style.display="none";
    });
    document.getElementById("editDocItem").addEventListener("click", ()=>{
      editDocument(document.getElementById("contextMenuDoc").targetDocName);
      document.getElementById("contextMenuDoc").style.display="none";
    });
    document.getElementById("deleteDocItem").addEventListener("click", ()=>{
      const docName = document.getElementById("contextMenuDoc").targetDocName;
      if(confirm(`Excluir documento "${docName}"?`)){
        deleteDocument(docName);
      }
      document.getElementById("contextMenuDoc").style.display="none";
    });
    function copyDoc(docName){
      const docObj = namedDocuments.find(d=>
        d.folderName===currentFolder &&
        (d.subFolderName||null)===(currentSubFolder||null) &&
        d.name===docName
      );
      if(!docObj){
        alert("Documento não encontrado.");
        return;
      }
      copyBuffer = {
        type:"document",
        name: docObj.name,
        folderName: docObj.folderName,
        subFolderName: docObj.subFolderName,
        subject: docObj.subject,
        content: docObj.content
      };
      alert(`Documento "${docName}" copiado. Vá onde deseja colar e clique direito.`);
    }
    function editDocument(oldDocName){
      const idx = namedDocuments.findIndex(d=>
        d.folderName===currentFolder &&
        (d.subFolderName||null)===(currentSubFolder||null) &&
        d.name===oldDocName
      );
      if(idx<0){
        alert("Documento não encontrado.");
        return;
      }
      const doc = namedDocuments[idx];
      const newName = prompt("Novo nome do documento:", doc.name);
      if(!newName) return;
      const newSubject = prompt("Novo assunto:", doc.subject||"");
      if(newSubject===null) return;

      const conflict = namedDocuments.find(d=>
        d!==doc &&
        d.folderName===currentFolder &&
        (d.subFolderName||null)===(currentSubFolder||null) &&
        d.name===newName
      );
      if(conflict){
        alert("Já existe um documento com esse nome aqui.");
        return;
      }
      doc.name = newName;
      doc.subject = newSubject;
      namedDocuments[idx] = doc;
      saveAllData();
      showDocumentList(currentFolder, currentSubFolder);
    }
    function deleteDocument(docName){
      namedDocuments = namedDocuments.filter(d=>
        !(d.folderName===currentFolder &&
          (d.subFolderName||null)===(currentSubFolder||null) &&
          d.name===docName)
      );
      saveAllData();
      showDocumentList(currentFolder, currentSubFolder);
    }

    /* ========== MENU DE CONTEXTO DE FUNDO ========== */
    function showContextMenuBackground(x,y,screenType){
      const menuBg = document.getElementById("contextMenuBackground");
      menuBg.style.display="block";
      menuBg.style.left = x+"px";
      menuBg.style.top  = y+"px";
      menuBg.screenType = screenType;
    }
    document.getElementById("folderScreen").addEventListener("contextmenu",(e)=>{
      if(e.target.classList.contains("folder-item") || e.target.closest(".folder-item")){
        return;
      }
      if(copyBuffer && copyBuffer.type==="folder"){
        e.preventDefault();
        showContextMenuBackground(e.pageX, e.pageY, "folderscreen");
      }
    });
    document.getElementById("subFolderScreen").addEventListener("contextmenu",(e)=>{
      if(e.target.classList.contains("subfolder-item") || e.target.closest(".subfolder-item")){
        return;
      }
      if(copyBuffer && copyBuffer.type==="subfolder"){
        e.preventDefault();
        showContextMenuBackground(e.pageX, e.pageY, "subfolderscreen");
      }
    });
    document.getElementById("documentListScreen").addEventListener("contextmenu",(e)=>{
      if(e.target.classList.contains("doc-item") || e.target.closest(".doc-item")){
        return;
      }
      if(copyBuffer && copyBuffer.type==="document"){
        e.preventDefault();
        showContextMenuBackground(e.pageX, e.pageY, "documentscreen");
      }
    });
    document.getElementById("pasteItem").addEventListener("click", ()=>{
      if(!copyBuffer){
        alert("Nada copiado.");
        return;
      }
      const st = document.getElementById("contextMenuBackground").screenType;
      document.getElementById("contextMenuBackground").style.display="none";
      if(st==="folderscreen"){
        if(copyBuffer.type==="folder"){
          pasteFolder();
        } else {
          alert("Só é possível colar Pastas aqui.");
        }
      }
      else if(st==="subfolderscreen"){
        if(copyBuffer.type==="subfolder"){
          pasteSubFolder();
        } else {
          alert("Só é possível colar Subpastas aqui.");
        }
      }
      else if(st==="documentscreen"){
        if(copyBuffer.type==="document"){
          pasteDocument();
        } else {
          alert("Só é possível colar Documentos aqui.");
        }
      }
    });
    function pasteFolder(){
      let newName = copyBuffer.name;
      let count = 1;
      while(folders.includes(newName)){
        newName = copyBuffer.name + " (Cópia" + (count>1?" "+count:"") + ")";
        count++;
      }
      folders.push(newName);
      folderSubfolders[newName] = copyBuffer.subfolders.slice();
      copyBuffer.docs.forEach(d=>{
        let docName = d.name;
        let docCount = 1;
        let conflict = namedDocuments.find(x=>
          x.folderName===newName && x.name===docName
        );
        while(conflict){
          docName = d.name + " (Cópia" + (docCount>1?" "+docCount:"") + ")";
          docCount++;
          conflict = namedDocuments.find(x=>
            x.folderName===newName && x.name===docName
          );
        }
        namedDocuments.push({
          folderName:newName,
          subFolderName:d.subFolderName||null,
          name:docName,
          subject:d.subject,
          content:d.content
        });
      });
      alert(`Pasta "${copyBuffer.name}" colada como "${newName}".`);
      saveAllData();
      showFolderScreen();
    }
    function pasteSubFolder(){
      if(!currentFolder){
        alert("Não há pasta atual selecionada para colar subpasta.");
        return;
      }
      let subs = folderSubfolders[currentFolder] || [];
      let newName = copyBuffer.name;
      let count = 1;
      while(subs.includes(newName)){
        newName = copyBuffer.name + " (Cópia" + (count>1?" "+count:"") + ")";
        count++;
      }
      subs.push(newName);
      folderSubfolders[currentFolder] = subs;
      copyBuffer.docs.forEach(d=>{
        let docName = d.name;
        let docCount = 1;
        let conflict = namedDocuments.find(x=>
          x.folderName===currentFolder &&
          (x.subFolderName||null)===newName &&
          x.name===docName
        );
        while(conflict){
          docName = d.name + " (Cópia" + (docCount>1?" "+docCount:"") + ")";
          docCount++;
          conflict = namedDocuments.find(x=>
            x.folderName===currentFolder &&
            (x.subFolderName||null)===newName &&
            x.name===docName
          );
        }
        namedDocuments.push({
          folderName:currentFolder,
          subFolderName:newName,
          name:docName,
          subject:d.subject,
          content:d.content
        });
      });
      alert(`Subpasta "${copyBuffer.name}" colada como "${newName}" em "${currentFolder}".`);
      saveAllData();
      showSubFolderScreen(currentFolder);
    }
    function pasteDocument(){
      if(!currentFolder){
        alert("Não há pasta atual para colar documento.");
        return;
      }
      let docName = copyBuffer.name;
      let docCount = 1;
      let conflict = namedDocuments.find(x=>
        x.folderName===currentFolder &&
        (x.subFolderName||null)===(currentSubFolder||null) &&
        x.name===docName
      );
      while(conflict){
        docName = copyBuffer.name + " (Cópia" + (docCount>1?" "+docCount:"") + ")";
        docCount++;
        conflict = namedDocuments.find(x=>
          x.folderName===currentFolder &&
          (x.subFolderName||null)===(currentSubFolder||null) &&
          x.name===docName
        );
      }
      namedDocuments.push({
        folderName: currentFolder,
        subFolderName: currentSubFolder||null,
        name: docName,
        subject: copyBuffer.subject||"",
        content: copyBuffer.content
      });
      alert(`Documento "${copyBuffer.name}" colado como "${docName}".`);
      saveAllData();
      showDocumentList(currentFolder, currentSubFolder);
    }

    /* ========== MENU DE CONTEXTO DO EDITOR ========== */
    function showEditorContextMenu(x,y,box){
      const contextMenuEditor = document.getElementById("contextMenu");
      contextMenuEditor.style.display="block";
      contextMenuEditor.style.left = x+"px";
      contextMenuEditor.style.top  = y+"px";
      contextMenuEditor.currentBox = box;
    }
    // Opção "Copiar Bloco" – agora o texto copiado incluirá a mensagem padrão
    const copyBlockBtn = document.getElementById("copyBlock");
    copyBlockBtn.addEventListener("click", () => {
      const box = document.getElementById("contextMenu").currentBox;
      if(box){
        // Copia com a mensagem padrão seguida do conteúdo do bloco
        navigator.clipboard.writeText("ME EXPLICA ESSE ASSUNTO DE MODO OBJETIVO, APENAS COM O NECESSÁRIO PARA ENTENDER ESSE TEXTO: " + box.innerText).catch(() => {
          // Tratamento de erro, se necessário
        });
      }
      document.getElementById("contextMenu").style.display="none";
    });
    document.getElementById("deleteBlock").addEventListener("click", ()=>{
      const box = document.getElementById("contextMenu").currentBox;
      if(box && box.parentNode){
        box.parentNode.removeChild(box);
      }
      document.getElementById("contextMenu").style.display="none";
    });
    document.getElementById("centerImageInsideBlock").addEventListener("click", ()=>{
      const box = document.getElementById("contextMenu").currentBox;
      if(!box) return;
      box.style.height="auto";
      box.style.overflow="visible";
      box.style.whiteSpace="normal";
      box.style.alignItems="center";
      box.style.justifyContent="center";
      box.style.padding="10px";
      box.style.flexDirection="column";
      const imgs = box.querySelectorAll("img");
      imgs.forEach(img=>{
        img.style.display="block";
        img.style.margin="0 auto";
        img.style.maxWidth="700px";
        img.style.height="auto";
      });
      const tables = box.querySelectorAll("table");
      tables.forEach(tbl=>{
        tbl.style.marginLeft="auto";
        tbl.style.marginRight="auto";
        tbl.style.width="auto";
      });
      document.getElementById("contextMenu").style.display="none";
    });

    // Submenus: fonte e cor
    document.getElementById("contextMenu").querySelectorAll('.submenu ul li[data-font-size]').forEach(li=>{
      li.addEventListener('click',()=>{
        const size = li.getAttribute('data-font-size');
        const box = document.getElementById("contextMenu").currentBox;
        if(box) box.style.fontSize=size;
        document.getElementById("contextMenu").style.display="none";
      });
    });
    document.getElementById("contextMenu").querySelectorAll('.submenu ul li[data-color]').forEach(li=>{
      li.addEventListener('click',()=>{
        const color = li.getAttribute('data-color');
        const box = document.getElementById("contextMenu").currentBox;
        if(box){
          box.style.backgroundColor=color;
        }
        document.getElementById("contextMenu").style.display="none";
      });
    });

  </script>
</body>
</html>
